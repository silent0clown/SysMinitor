<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统监控面板</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .usage-meter {
            width: 100%;
            height: 30px;
            background-color: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        .usage-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #FFC107, #F44336);
            transition: width 0.5s ease;
        }
        .disk-usage-bar {
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 5px 0;
        }
        .disk-usage-fill {
            height: 100%;
            background: linear-gradient(90deg, #2196F3, #03A9F4);
            transition: width 0.5s ease;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        /* 进程列表样式 */
        .process-header, .disk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .process-header:hover, .disk-header:hover {
            background: #e9ecef;
        }
        .process-controls, .disk-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .sort-select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        .refresh-btn {
            padding: 5px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .refresh-btn:hover {
            background: #0056b3;
        }
        .process-list, .disk-list {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }
        .process-table, .disk-table {
            width: 100%;
            border-collapse: collapse;
        }
        .process-table th, .disk-table th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
        }
        .process-table td, .disk-table td {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
        }
        .process-table tr:hover, .disk-table tr:hover {
            background: #f8f9fa;
        }
        .process-name {
            font-weight: 500;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .process-pid {
            color: #666;
            font-family: monospace;
        }
        .process-cpu {
            color: #e74c3c;
            font-weight: 500;
        }
        .process-memory {
            color: #3498db;
            font-weight: 500;
        }
        .process-user {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .process-state {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .state-running {
            background: #d4edda;
            color: #155724;
        }
        .collapsed .process-list, .collapsed .disk-list {
            display: none;
        }
        .toggle-icon {
            transition: transform 0.3s ease;
        }
        .collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        .show-all-btn {
            width: 100%;
            padding: 10px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        .show-all-btn:hover {
            background: #545b62;
        }
        
        /* 磁盘信息样式 */
        .disk-drive-letter {
            font-weight: bold;
            color: #2196F3;
            font-size: 16px;
        }
        .disk-usage-percent {
            font-weight: bold;
            color: #e74c3c;
        }
        .disk-size {
            color: #666;
            font-family: monospace;
        }
        .disk-file-system {
            color: #27ae60;
            font-weight: 500;
        }
        .disk-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-healthy {
            background: #d4edda;
            color: #155724;
        }
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        /* 性能指标样式 */
        .performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .performance-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
        }
        .performance-value {
            font-size: 20px;
            font-weight: bold;
            color: #2196F3;
        }
        .performance-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        /* 选项卡样式 */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background: white;
            border-color: #ddd;
            border-bottom-color: white;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* 注册表监控样式 */
        .registry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .registry-header:hover {
            background: #e9ecef;
        }
        .registry-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .registry-section {
            max-height: 800px;
            overflow-y: auto;
        }
        .collapsed .registry-section {
            display: none;
        }

        /* 快照管理样式 */
        .snapshot-management {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .snapshot-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        .snapshots-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .snapshot-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .snapshot-item:hover {
            border-color: #007bff;
        }
        .snapshot-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .snapshot-meta {
            font-size: 12px;
            color: #666;
        }
        .snapshot-actions {
            margin-top: 5px;
        }
        .btn-primary {
            background: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        .snapshot-select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }

        /* 比较结果样式 */
        .comparison-result {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .change-added {
            color: #28a745;
            font-weight: bold;
        }
        .change-removed {
            color: #dc3545;
            font-weight: bold;
        }
        .change-modified {
            color: #ffc107;
            font-weight: bold;
        }

        /* 注册表内容样式 */
        .registry-content {
            max-height: 400px;
            overflow-y: auto;
        }
        .registry-key {
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }
        .registry-key-header {
            background: #f8f9fa;
            padding: 10px;
            font-weight: bold;
            cursor: pointer;
            border-bottom: 1px solid #e0e0e0;
        }
        .registry-key-content {
            padding: 10px;
            background: white;
        }
        .registry-value {
            display: flex;
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #f0f0f0;
        }
        .registry-value-name {
            font-weight: bold;
            min-width: 150px;
        }
        .registry-value-type {
            color: #6c757d;
            min-width: 80px;
            font-size: 12px;
        }
        .registry-value-data {
            flex: 1;
            word-break: break-all;
        }

        /* 驱动信息样式 */
        .driver-state {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .state-running {
            background: #d4edda;
            color: #155724;
        }

        .state-stopped {
            background: #f8d7da;
            color: #721c24;
        }

        .state-pending {
            background: #fff3cd;
            color: #856404;
        }

        .state-unknown {
            background: #e2e3e5;
            color: #383d41;
        }

        /* 驱动表格特定样式 */
        #driverList .process-table {
            font-size: 12px;
        }

        #driverList .process-table th {
            padding: 8px 4px;
            font-size: 11px;
        }

        #driverList .process-table td {
            padding: 6px 4px;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🖥️ 系统监控面板</h1>
        
        <div class="card">
            <h2>CPU使用率</h2>
            <div class="usage-meter">
                <div id="usageBar" class="usage-bar" style="width: 0%"></div>
            </div>
            <div id="usageText" style="text-align: center; font-size: 24px; font-weight: bold;">0%</div>
        </div>

        <div class="card">
            <h2>CPU信息</h2>
            <div id="cpuInfo">
                <p>加载中...</p>
            </div>
        </div>

        <div class="card">
            <h2>实时数据</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="currentUsage">0%</div>
                    <div class="stat-label">当前使用率</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="coreCount">0</div>
                    <div class="stat-label">物理核心</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="threadCount">0</div>
                    <div class="stat-label">逻辑核心</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="frequency">0</div>
                    <div class="stat-label">基础频率 (MHz)</div>
                </div>
            </div>
        </div>

        <!-- 磁盘信息窗口 -->
        <div class="card">
            <div class="disk-header" onclick="toggleDiskList()">
                <h2 style="margin: 0;">磁盘信息 
                    <span id="diskCount" style="font-size: 14px; color: #666; margin-left: 10px;"></span>
                </h2>
                <div class="disk-controls" onclick="event.stopPropagation()">
                    <button class="refresh-btn" onclick="loadDiskInfo()">刷新</button>
                    <span class="toggle-icon">▼</span>
                </div>
            </div>
            
            <div id="diskList" class="disk-list">
                <!-- 选项卡 -->
                <div class="tabs">
                    <div class="tab active" onclick="switchDiskTab('partitions')">分区信息</div>
                    <div class="tab" onclick="switchDiskTab('performance')">性能监控</div>
                    <div class="tab" onclick="switchDiskTab('drives')">磁盘驱动器</div>
                </div>
                
                <!-- 分区信息标签页 -->
                <div id="partitionsTab" class="tab-content active">
                    <table class="disk-table">
                        <thead>
                            <tr>
                                <th width="8%">盘符</th>
                                <th width="15%">卷标</th>
                                <th width="12%">文件系统</th>
                                <th width="15%">总空间</th>
                                <th width="15%">已用空间</th>
                                <th width="15%">可用空间</th>
                                <th width="10%">使用率</th>
                                <th width="10%">状态</th>
                            </tr>
                        </thead>
                        <tbody id="partitionsTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 20px;">
                                    加载中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 性能监控标签页 -->
                <div id="performanceTab" class="tab-content">
                    <div id="performanceContent">
                        <p style="text-align: center; padding: 20px;">加载中...</p>
                    </div>
                </div>
                
                <!-- 磁盘驱动器标签页 -->
                <div id="drivesTab" class="tab-content">
                    <table class="disk-table">
                        <thead>
                            <tr>
                                <th width="20%">型号</th>
                                <th width="15%">序列号</th>
                                <th width="10%">接口类型</th>
                                <th width="10%">介质类型</th>
                                <th width="15%">总容量</th>
                                <th width="10%">扇区大小</th>
                                <th width="10%">状态</th>
                                <th width="10%">设备ID</th>
                            </tr>
                        </thead>
                        <tbody id="drivesTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 20px;">
                                    加载中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 进程信息窗口 -->
        <div class="card">
            <div class="process-header" onclick="toggleProcessList()">
                <h2 style="margin: 0;">进程信息 
                    <span id="processCount" style="font-size: 14px; color: #666; margin-left: 10px;"></span>
                </h2>
                <div class="process-controls" onclick="event.stopPropagation()">
                    <span>排序方式:</span>
                    <select class="sort-select" id="sortSelect" onchange="sortProcesses()">
                        <option value="name">进程名称</option>
                        <option value="cpu">CPU占用率</option>
                        <option value="memory">内存占用</option>
                        <option value="pid">进程ID</option>
                    </select>
                    <button class="refresh-btn" onclick="loadProcesses()">刷新</button>
                    <span class="toggle-icon">▼</span>
                </div>
            </div>
            
            <div id="processList" class="process-list">
                <table class="process-table">
                    <thead>
                        <tr>
                            <th width="5%">PID</th>
                            <th width="20%">进程名称</th>
                            <th width="10%">CPU</th>
                            <th width="15%">内存</th>
                            <th width="10%">线程</th>
                            <th width="15%">用户名</th>
                            <th width="10%">状态</th>
                            <th width="15%">路径</th>
                        </tr>
                    </thead>
                    <tbody id="processTableBody">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 20px;">
                                加载中...
                            </td>
                        </tr>
                    </tbody>
                </table>
                <button class="show-all-btn" onclick="toggleAllProcesses()">显示全部进程</button>
            </div>
        </div>

        <!-- 注册表监控窗口 -->
        <div class="card">
            <div class="registry-header" onclick="toggleRegistrySection()">
                <h2 style="margin: 0;">注册表监控 
                    <span id="registrySnapshotCount" style="font-size: 14px; color: #666; margin-left: 10px;"></span>
                </h2>
                <div class="registry-controls" onclick="event.stopPropagation()">
                    <button class="refresh-btn" onclick="loadRegistrySnapshot()">刷新快照</button>
                    <button class="refresh-btn" onclick="saveRegistrySnapshot()">保存快照</button>
                    <span class="toggle-icon">▼</span>
                </div>
            </div>
            
            <div id="registrySection" class="registry-section">
                <!-- 快照管理 -->
                <div class="snapshot-management">
                    <h3>快照管理</h3>
                    <div class="snapshot-controls">
                        <input type="text" id="snapshotName" placeholder="快照名称" style="padding: 5px; margin-right: 10px;">
                        <button class="btn-primary" onclick="saveRegistrySnapshot()">保存当前快照</button>
                        <button class="btn-secondary" onclick="loadSavedSnapshots()">刷新快照列表</button>
                    </div>
                    
                    <div class="snapshot-list">
                        <h4>已保存的快照</h4>
                        <div id="savedSnapshotsList" class="snapshots-container">
                            <!-- 快照列表将在这里动态生成 -->
                        </div>
                    </div>
                    
                    <div class="snapshot-comparison">
                        <h4>快照比较</h4>
                        <div class="comparison-controls">
                            <select id="compareSnapshot1" class="snapshot-select">
                                <option value="">选择第一个快照</option>
                            </select>
                            <select id="compareSnapshot2" class="snapshot-select">
                                <option value="">选择第二个快照</option>
                            </select>
                            <button class="btn-primary" onclick="compareSnapshots()">比较快照</button>
                        </div>
                        <div id="comparisonResult" class="comparison-result">
                            <!-- 比较结果将在这里显示 -->
                        </div>
                    </div>
                </div>
                
                <!-- 当前快照详情 -->
                <div class="current-snapshot">
                    <h3>当前注册表快照</h3>
                    <div class="tabs">
                        <div class="tab active" onclick="switchRegistryTab('systemInfo')">系统信息</div>
                        <div class="tab" onclick="switchRegistryTab('software')">软件信息</div>
                        <div class="tab" onclick="switchRegistryTab('network')">网络配置</div>
                    </div>
                    
                    <div id="systemInfoTab" class="tab-content active">
                        <div id="systemInfoContent" class="registry-content">
                            <!-- 系统信息内容 -->
                        </div>
                    </div>
                    
                    <div id="softwareTab" class="tab-content">
                        <div id="softwareContent" class="registry-content">
                            <!-- 软件信息内容 -->
                        </div>
                    </div>
                    
                    <div id="networkTab" class="tab-content">
                        <div id="networkContent" class="registry-content">
                            <!-- 网络配置内容 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 驱动信息窗口 -->
<div class="card">
    <div class="process-header" onclick="toggleDriverList()">
        <h2 style="margin: 0;">驱动信息 
            <span id="driverCount" style="font-size: 14px; color: #666; margin-left: 10px;"></span>
        </h2>
        <div class="process-controls" onclick="event.stopPropagation()">
            <span>排序方式:</span>
            <select class="sort-select" id="driverSortSelect" onchange="sortDrivers()">
                <option value="name">驱动名称</option>
                <option value="state">状态</option>
                <option value="type">类型</option>
                <option value="startType">启动类型</option>
            </select>
            <button class="refresh-btn" onclick="loadDriverInfo()">刷新</button>
            <span class="toggle-icon">▼</span>
        </div>
    </div>
    
    <div id="driverList" class="process-list">
        <!-- 统计信息 -->
        <div class="stats-grid" id="driverStats" style="margin: 15px 0;">
            <!-- 统计信息将在这里动态生成 -->
        </div>
        
        <!-- 选项卡 -->
        <div class="tabs">
            <div class="tab active" onclick="switchDriverTab('all')">全部驱动</div>
            <div class="tab" onclick="switchDriverTab('running')">运行中</div>
            <div class="tab" onclick="switchDriverTab('kernel')">内核驱动</div>
            <div class="tab" onclick="switchDriverTab('filesystem')">文件系统</div>
            <div class="tab" onclick="switchDriverTab('autostart')">自动启动</div>
            <div class="tab" onclick="switchDriverTab('thirdparty')">第三方驱动</div>
        </div>
        
        <!-- 全部驱动标签页 -->
        <div id="allTab" class="tab-content active">
            <table class="process-table">
                <thead>
                    <tr>
                        <th width="15%">驱动名称</th>
                        <th width="20%">显示名称</th>
                        <th width="10%">状态</th>
                        <th width="10%">类型</th>
                        <th width="10%">启动类型</th>
                        <th width="15%">文件路径</th>
                        <th width="10%">PID</th>
                        <th width="10%">错误控制</th>
                    </tr>
                </thead>
                <tbody id="allDriversTableBody">
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px;">
                            加载中...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- 运行中驱动标签页 -->
        <div id="runningTab" class="tab-content">
            <table class="process-table">
                <thead>
                    <tr>
                        <th width="15%">驱动名称</th>
                        <th width="20%">显示名称</th>
                        <th width="10%">PID</th>
                        <th width="15%">文件路径</th>
                        <th width="10%">启动类型</th>
                        <th width="10%">类型</th>
                        <th width="20%">描述</th>
                    </tr>
                </thead>
                <tbody id="runningDriversTableBody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px;">
                            加载中...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- 内核驱动标签页 -->
        <div id="kernelTab" class="tab-content">
            <table class="process-table">
                <thead>
                    <tr>
                        <th width="15%">驱动名称</th>
                        <th width="20%">显示名称</th>
                        <th width="10%">状态</th>
                        <th width="10%">启动类型</th>
                        <th width="15%">文件路径</th>
                        <th width="10%">错误控制</th>
                        <th width="20%">描述</th>
                    </tr>
                </thead>
                <tbody id="kernelDriversTableBody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px;">
                            加载中...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- 文件系统驱动标签页 -->
        <div id="filesystemTab" class="tab-content">
            <table class="process-table">
                <thead>
                    <tr>
                        <th width="15%">驱动名称</th>
                        <th width="20%">显示名称</th>
                        <th width="10%">状态</th>
                        <th width="10%">启动类型</th>
                        <th width="15%">文件路径</th>
                        <th width="10%">错误控制</th>
                        <th width="20%">描述</th>
                    </tr>
                </thead>
                <tbody id="filesystemDriversTableBody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px;">
                            加载中...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- 自动启动驱动标签页 -->
        <div id="autostartTab" class="tab-content">
            <table class="process-table">
                <thead>
                    <tr>
                        <th width="15%">驱动名称</th>
                        <th width="20%">显示名称</th>
                        <th width="10%">状态</th>
                        <th width="10%">启动类型</th>
                        <th width="15%">文件路径</th>
                        <th width="10%">类型</th>
                        <th width="20%">描述</th>
                    </tr>
                </thead>
                <tbody id="autostartDriversTableBody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px;">
                            加载中...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- 第三方驱动标签页 -->
        <div id="thirdpartyTab" class="tab-content">
            <table class="process-table">
                <thead>
                    <tr>
                        <th width="15%">驱动名称</th>
                        <th width="20%">显示名称</th>
                        <th width="10%">状态</th>
                        <th width="10%">启动类型</th>
                        <th width="25%">文件路径</th>
                        <th width="10%">类型</th>
                        <th width="10%">PID</th>
                    </tr>
                </thead>
                <tbody id="thirdpartyDriversTableBody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px;">
                            加载中...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <button class="show-all-btn" onclick="toggleAllDrivers()">显示详细信息</button>
    </div>
</div>

    </div>

    <script>
        // 全局变量
        let allProcesses = [];
        let showAllProcesses = false;
        let currentSort = 'name';
        let diskData = {};

        // 获取CPU信息
        async function fetchCPUInfo() {
            try {
                const response = await fetch('/api/cpu/info');
                const data = await response.json();
                
                document.getElementById('cpuInfo').innerHTML = `
                    <p><strong>名称:</strong> ${data.name}</p>
                    <p><strong>架构:</strong> ${data.architecture}</p>
                    <p><strong>物理核心:</strong> ${data.physicalCores}</p>
                    <p><strong>逻辑核心:</strong> ${data.logicalCores}</p>
                    <p><strong>基础频率:</strong> ${data.baseFrequency} MHz</p>
                    ${data.maxFrequency ? `<p><strong>最大频率:</strong> ${data.maxFrequency} MHz</p>` : ''}
                `;
                
                document.getElementById('coreCount').textContent = data.physicalCores;
                document.getElementById('threadCount').textContent = data.logicalCores;
                document.getElementById('frequency').textContent = data.baseFrequency;
            } catch (error) {
                console.error('获取CPU信息失败:', error);
            }
        }

        // 更新CPU使用率
        function updateCPUUsage() {
            fetch('/api/cpu/usage')
                .then(response => response.json())
                .then(data => {
                    const usage = data.usage.toFixed(1);
                    document.getElementById('usageText').textContent = usage + '%';
                    document.getElementById('usageBar').style.width = usage + '%';
                    document.getElementById('currentUsage').textContent = usage + '%';
                })
                .catch(error => console.error('获取CPU使用率失败:', error));
        }

        // 加载磁盘信息
        async function loadDiskInfo() {
            try {
                const response = await fetch('/api/disk/info');
                const data = await response.json();
                
                diskData = data;
                document.getElementById('diskCount').textContent = `(${data.partitions ? data.partitions.length : 0} 个分区)`;
                
                displayPartitions(data.partitions || []);
                displayDrives(data.drives || []);
                
            } catch (error) {
                console.error('获取磁盘信息失败:', error);
                document.getElementById('partitionsTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: #dc3545; padding: 20px;">
                            加载失败: ${error.message}
                        </td>
                    </tr>
                `;
            }
            
            // 加载性能数据
            loadDiskPerformance();
        }

        // 显示分区信息
        function displayPartitions(partitions) {
            const tbody = document.getElementById('partitionsTableBody');
            
            if (partitions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px;">
                            没有找到分区信息
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = partitions.map(partition => {
                const usagePercentage = partition.usagePercentage || 0;
                const status = usagePercentage > 90 ? 'Warning' : 'Healthy';
                
                return `
                    <tr>
                        <td class="disk-drive-letter">${partition.driveLetter}</td>
                        <td>${partition.label || '无卷标'}</td>
                        <td class="disk-file-system">${partition.fileSystem || '未知'}</td>
                        <td class="disk-size">${formatBytes(partition.totalSize)}</td>
                        <td class="disk-size">${formatBytes(partition.usedSpace)}</td>
                        <td class="disk-size">${formatBytes(partition.freeSpace)}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="disk-usage-percent">${usagePercentage.toFixed(1)}%</span>
                                <div class="disk-usage-bar" style="flex: 1;">
                                    <div class="disk-usage-fill" style="width: ${usagePercentage}%"></div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="disk-status status-${status.toLowerCase()}">${status === 'Healthy' ? '正常' : '警告'}</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 显示磁盘驱动器信息
        function displayDrives(drives) {
            const tbody = document.getElementById('drivesTableBody');
            
            if (drives.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px;">
                            没有找到磁盘驱动器信息
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = drives.map(drive => `
                <tr>
                    <td title="${drive.model}">${truncateText(drive.model, 25)}</td>
                    <td>${drive.serialNumber || '未知'}</td>
                    <td>${drive.interfaceType || '未知'}</td>
                    <td>${drive.mediaType || '未知'}</td>
                    <td class="disk-size">${formatBytes(drive.totalSize)}</td>
                    <td>${drive.bytesPerSector ? drive.bytesPerSector + ' 字节' : '未知'}</td>
                    <td>
                        <span class="disk-status status-healthy">${drive.status || '正常'}</span>
                    </td>
                    <td>${drive.deviceId || '未知'}</td>
                </tr>
            `).join('');
        }

        // 加载磁盘性能数据
        async function loadDiskPerformance() {
            try {
                const response = await fetch('/api/disk/performance');
                const data = await response.json();
                
                displayPerformance(data.performance || []);
            } catch (error) {
                console.error('获取磁盘性能失败:', error);
                document.getElementById('performanceContent').innerHTML = `
                    <p style="text-align: center; color: #dc3545;">
                        加载性能数据失败: ${error.message}
                    </p>
                `;
            }
        }

        // 显示性能数据
        function displayPerformance(performance) {
            const container = document.getElementById('performanceContent');
            
            if (performance.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; padding: 20px;">
                        没有性能数据可用
                    </p>
                `;
                return;
            }
            
            container.innerHTML = performance.map(perf => `
                <div style="margin-bottom: 20px;">
                    <h4>${perf.driveLetter === '_Total' ? '总体磁盘性能' : '磁盘 ' + perf.driveLetter}</h4>
                    <div class="performance-grid">
                        <div class="performance-card">
                            <div class="performance-value">${perf.readSpeed ? perf.readSpeed.toFixed(2) : '0'} MB/s</div>
                            <div class="performance-label">读取速度</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-value">${perf.writeSpeed ? perf.writeSpeed.toFixed(2) : '0'} MB/s</div>
                            <div class="performance-label">写入速度</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-value">${perf.usagePercentage ? perf.usagePercentage.toFixed(1) : '0'}%</div>
                            <div class="performance-label">磁盘使用率</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-value">${perf.queueLength ? perf.queueLength.toFixed(2) : '0'}</div>
                            <div class="performance-label">队列长度</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-value">${formatBytes(perf.readBytesPerSec || 0)}/s</div>
                            <div class="performance-label">读取字节数</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-value">${formatBytes(perf.writeBytesPerSec || 0)}/s</div>
                            <div class="performance-label">写入字节数</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 切换磁盘标签页
        function switchDiskTab(tabName) {
            // 隐藏所有标签页内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 移除所有标签的激活状态
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选中的标签页内容
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // 激活选中的标签
            event.target.classList.add('active');
        }

        // 切换磁盘列表显示/隐藏
        function toggleDiskList() {
            const diskList = document.getElementById('diskList');
            const card = diskList.closest('.card');
            card.classList.toggle('collapsed');
        }

        // 格式化字节大小
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 截断文本
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        // 进程相关函数
        async function loadProcesses() {
            try {
                const response = await fetch('/api/processes');
                const data = await response.json();
                
                allProcesses = data.processes || [];
                document.getElementById('processCount').textContent = `(${allProcesses.length} 个进程)`;
                
                sortAndDisplayProcesses();
            } catch (error) {
                console.error('获取进程列表失败:', error);
                document.getElementById('processTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: #dc3545; padding: 20px;">
                            加载失败: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        function sortAndDisplayProcesses() {
            const sortedProcesses = [...allProcesses];
            
            switch (currentSort) {
                case 'name':
                    sortedProcesses.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'cpu':
                    sortedProcesses.sort((a, b) => b.cpuUsage - a.cpuUsage);
                    break;
                case 'memory':
                    sortedProcesses.sort((a, b) => b.memoryUsage - a.memoryUsage);
                    break;
                case 'pid':
                    sortedProcesses.sort((a, b) => a.pid - b.pid);
                    break;
            }
            
            const displayProcesses = showAllProcesses ? sortedProcesses : sortedProcesses.slice(0, 20);
            displayProcessList(displayProcesses);
        }

        function displayProcessList(processes) {
            const tbody = document.getElementById('processTableBody');
            
            if (processes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px;">
                            没有找到进程信息
                        </td>
                    </tr>
                `;
                return;
            }
            
            const validProcesses = processes.map(process => {
                let cpuUsage = process.cpuUsage;
                if (!isFinite(cpuUsage) || cpuUsage < 0 || cpuUsage > 100) {
                    cpuUsage = 0;
                }
                
                return {
                    ...process,
                    cpuUsage: cpuUsage
                };
            });
            
            tbody.innerHTML = validProcesses.map(process => `
                <tr>
                    <td class="process-pid">${process.pid}</td>
                    <td class="process-name" title="${process.name}">${process.name}</td>
                    <td class="process-cpu">${process.cpuUsage.toFixed(1)}%</td>
                    <td class="process-memory">${formatBytes(process.memoryUsage)}</td>
                    <td>${process.threadCount}</td>
                    <td class="process-user" title="${process.username}">${process.username}</td>
                    <td>
                        <span class="process-state state-running">${process.state}</span>
                    </td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
                        title="${process.fullPath || ''}">
                        ${process.fullPath || 'N/A'}
                    </td>
                </tr>
            `).join('');
        }

        function sortProcesses() {
            currentSort = document.getElementById('sortSelect').value;
            sortAndDisplayProcesses();
        }

        function toggleProcessList() {
            const processList = document.getElementById('processList');
            const card = processList.closest('.card');
            card.classList.toggle('collapsed');
        }

        function toggleAllProcesses() {
            showAllProcesses = !showAllProcesses;
            const button = document.querySelector('.show-all-btn');
            button.textContent = showAllProcesses ? '显示前20个进程' : '显示全部进程';
            sortAndDisplayProcesses();
        }
        
        // 注册表相关功能
        let currentRegistrySnapshot = null;
        let savedSnapshots = [];

        // 加载注册表快照
        async function loadRegistrySnapshot() {
            try {
                console.log('开始加载注册表快照...');
                const response = await fetch('/api/registry/snapshot');
                
                console.log('响应状态:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                }
                
                const responseText = await response.text();
                console.log('响应内容:', responseText);
                
                if (!responseText) {
                    throw new Error('服务器返回空响应');
                }
                
                const data = JSON.parse(responseText);
                console.log('解析后的数据:', data);
                
                currentRegistrySnapshot = data;
                displayRegistrySnapshot(data);
                
                document.getElementById('registrySnapshotCount').textContent = 
                    `(系统: ${data.systemInfo.length}, 软件: ${data.software.length}, 网络: ${data.network.length})`;
                    
            } catch (error) {
                console.error('加载注册表快照失败:', error);
                alert('加载注册表快照失败: ' + error.message);
            }
        }

        // 保存注册表快照
        async function saveRegistrySnapshot() {
            try {
                const snapshotName = document.getElementById('snapshotName').value || 
                                `snapshot_${new Date().toISOString().replace(/[:.]/g, '-')}`;
                
                console.log('开始保存快照:', snapshotName);
                
                // 首先获取当前的注册表快照
                console.log('正在获取当前注册表状态...');
                const snapshotResponse = await fetch('/api/registry/snapshot');
                
                if (!snapshotResponse.ok) {
                    throw new Error(`获取快照失败: ${snapshotResponse.status}`);
                }
                
                const snapshotData = await snapshotResponse.json();
                console.log('获取到快照数据:', snapshotData);
                
                // 发送包含快照数据的POST请求
                const saveData = {
                    snapshotName: snapshotName,
                    timestamp: Date.now(),
                    systemInfo: snapshotData.systemInfo || [],
                    software: snapshotData.software || [],
                    network: snapshotData.network || []
                };
                
                console.log('发送保存请求，数据大小:', JSON.stringify(saveData).length, '字节');
                
                const response = await fetch('/api/registry/snapshot/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(saveData)
                });
                
                console.log('保存响应状态:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP错误: ${response.status} ${response.statusText} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('保存结果:', result);
                
                if (result.success) {
                    alert('快照保存成功: ' + snapshotName);
                    document.getElementById('snapshotName').value = '';
                    loadSavedSnapshots();
                } else {
                    alert('保存失败: ' + result.error);
                }
            } catch (error) {
                console.error('保存快照失败:', error);
                alert('保存快照失败: ' + error.message);
            }
        }

        // 加载已保存的快照列表
        async function loadSavedSnapshots() {
            try {
                const response = await fetch('/api/registry/snapshots');
                savedSnapshots = await response.json();
                
                displaySavedSnapshots();
                updateComparisonSelects();
                
            } catch (error) {
                console.error('加载快照列表失败:', error);
            }
        }

        // 显示已保存的快照
        function displaySavedSnapshots() {
            const container = document.getElementById('savedSnapshotsList');
            
            if (savedSnapshots.length === 0) {
                container.innerHTML = '<p>暂无保存的快照</p>';
                return;
            }
            
            container.innerHTML = savedSnapshots.map(snapshot => `
                <div class="snapshot-item">
                    <div class="snapshot-name">${snapshot.name}</div>
                    <div class="snapshot-meta">
                        时间: ${new Date(snapshot.timestamp).toLocaleString()}<br>
                        系统: ${snapshot.systemInfoCount} | 软件: ${snapshot.softwareCount} | 网络: ${snapshot.networkCount}
                    </div>
                    <div class="snapshot-actions">
                        <button class="btn-danger" onclick="deleteSnapshot('${snapshot.name}')">删除</button>
                    </div>
                </div>
            `).join('');
        }

        // 删除快照
        async function deleteSnapshot(snapshotName) {
            if (!confirm(`确定要删除快照 "${snapshotName}" 吗？`)) {
                return;
            }
            try {
                
                const response = await fetch(`/api/registry/snapshots/delete/${encodeURIComponent(snapshotName)}`, {
                // const response = await fetch(`/api/registry/snapshots/${encodeURIComponent(snapshotName)}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    loadSavedSnapshots();
                } else {
                    alert('删除失败: ' + result.error);
                }
            } catch (error) {
                console.error('删除快照失败:', error);
                alert('删除快照失败: ' + error.message);
            }
        }

        // 更新比较选择框
        function updateComparisonSelects() {
            const select1 = document.getElementById('compareSnapshot1');
            const select2 = document.getElementById('compareSnapshot2');
            
            select1.innerHTML = '<option value="">选择第一个快照</option>';
            select2.innerHTML = '<option value="">选择第二个快照</option>';
            
            savedSnapshots.forEach(snapshot => {
                const option = `<option value="${snapshot.name}">${snapshot.name}</option>`;
                select1.innerHTML += option;
                select2.innerHTML += option;
            });
        }

        // 比较快照
        async function compareSnapshots() {
            try {
                const snapshot1 = document.getElementById('compareSnapshot1').value;
                const snapshot2 = document.getElementById('compareSnapshot2').value;
                
                if (!snapshot1 || !snapshot2) {
                    alert('请选择要比较的两个快照');
                    return;
                }
                
                if (snapshot1 === snapshot2) {
                    alert('请选择两个不同的快照进行比较');
                    return;
                }
                
                console.log('开始比较快照:', snapshot1, 'vs', snapshot2);
                
                // 修改为POST请求，通过请求体传递参数
                const requestBody = {
                    snapshot1: snapshot1,
                    snapshot2: snapshot2
                };
                
                const response = await fetch('/api/registry/snapshots/compare', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('比较响应状态:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('比较响应内容:', errorText);
                    throw new Error(`HTTP错误: ${response.status} ${response.statusText} - ${errorText}`);
                }
                
                // 检查响应内容类型
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('非JSON响应:', text);
                    throw new Error('服务器返回了非JSON格式的响应');
                }
                
                const result = await response.json();
                console.log('比较结果:', result);
                
                displayComparisonResult(result);
                
            } catch (error) {
                console.error('比较快照失败:', error);
                alert('比较快照失败: ' + error.message);
            }
        }

        // 显示比较结果
        function displayComparisonResult(result) {
            const container = document.getElementById('comparisonResult');
            
            let html = `
                <h5>快照比较结果: ${result.snapshot1} vs ${result.snapshot2}</h5>
                <p>时间: ${new Date(result.timestamp1).toLocaleString()} vs ${new Date(result.timestamp2).toLocaleString()}</p>
            `;
            
            // 系统信息变化
            html += `<h6>系统信息变化:</h6>`;
            html += displayChanges(result.systemInfoChanges);
            
            // 软件信息变化
            html += `<h6>软件信息变化:</h6>`;
            html += displayChanges(result.softwareChanges);
            
            // 网络配置变化
            html += `<h6>网络配置变化:</h6>`;
            html += displayChanges(result.networkChanges);
            
            container.innerHTML = html;
        }

        function displayChanges(changes) {
            return `
                <div class="change-added">新增: ${changes.added.length} 项</div>
                <div class="change-removed">删除: ${changes.removed.length} 项</div>
                <div class="change-modified">修改: ${changes.modified.length} 项</div>
            `;
        }

        // 显示注册表快照
        function displayRegistrySnapshot(snapshot) {
            displaySystemInfo(snapshot.systemInfo);
            displaySoftwareInfo(snapshot.software);
            displayNetworkInfo(snapshot.network);
        }

        function displaySystemInfo(systemInfo) {
            const container = document.getElementById('systemInfoContent');
            container.innerHTML = systemInfo.map(key => `
                <div class="registry-key">
                    <div class="registry-key-header">${key.path}</div>
                    <div class="registry-key-content">
                        ${key.values.map(value => `
                            <div class="registry-value">
                                <div class="registry-value-name">${value.name}</div>
                                <div class="registry-value-type">${value.type}</div>
                                <div class="registry-value-data">${value.data}</div>
                            </div>
                        `).join('')}
                        ${key.subkeys.length > 0 ? `<div><strong>子键:</strong> ${key.subkeys.join(', ')}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function displaySoftwareInfo(softwareInfo) {
            const container = document.getElementById('softwareContent');
            container.innerHTML = softwareInfo.map(key => `
                <div class="registry-key">
                    <div class="registry-key-header">${key.path}</div>
                    <div class="registry-key-content">
                        ${key.values.map(value => `
                            <div class="registry-value">
                                <div class="registry-value-name">${value.name}</div>
                                <div class="registry-value-type">${value.type}</div>
                                <div class="registry-value-data">${value.data}</div>
                            </div>
                        `).join('')}
                        ${key.subkeys.length > 0 ? `<div><strong>子键:</strong> ${key.subkeys.join(', ')}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function displayNetworkInfo(networkInfo) {
            const container = document.getElementById('networkContent');
            container.innerHTML = networkInfo.map(key => `
                <div class="registry-key">
                    <div class="registry-key-header">${key.path}</div>
                    <div class="registry-key-content">
                        ${key.values.map(value => `
                            <div class="registry-value">
                                <div class="registry-value-name">${value.name}</div>
                                <div class="registry-value-type">${value.type}</div>
                                <div class="registry-value-data">${value.data}</div>
                            </div>
                        `).join('')}
                        ${key.subkeys.length > 0 ? `<div><strong>子键:</strong> ${key.subkeys.join(', ')}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // 切换注册表标签页
        function switchRegistryTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        // 切换注册表区域显示/隐藏
        function toggleRegistrySection() {
            const registrySection = document.getElementById('registrySection');
            const card = registrySection.closest('.card');
            card.classList.toggle('collapsed');
        }


        // 驱动信息相关变量
        let currentDriversData = null;
        let driverShowAll = false;

        // 切换驱动列表显示/隐藏
        function toggleDriverList() {
            const driverList = document.getElementById('driverList');
            const header = document.querySelector('.process-header');
            driverList.classList.toggle('collapsed');
            header.classList.toggle('collapsed');
        }

        // 切换驱动标签页
        function switchDriverTab(tabName) {
            // 隐藏所有标签页
            document.querySelectorAll('#driverList .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 移除所有标签的active类
            document.querySelectorAll('#driverList .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 激活选中的标签页和标签
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        // 加载驱动信息
        async function loadDriverInfo() {
            try {
                const response = await fetch('/api/drivers/snapshot');
                if (!response.ok) {
                    throw new Error('获取驱动信息失败');
                }
                
                const data = await response.json();
                currentDriversData = data;
                
                // 更新统计信息
                updateDriverStats(data);
                
                // 更新各标签页内容
                updateDriverTables(data);
                
                // 更新计数显示
                document.getElementById('driverCount').textContent = 
                    `总计: ${data.statistics.totalDrivers} 个驱动`;
                    
                console.log('驱动信息加载成功');
                
            } catch (error) {
                console.error('加载驱动信息失败:', error);
                alert('加载驱动信息失败: ' + error.message);
            }
        }

        // 更新驱动统计信息
        function updateDriverStats(data) {
            const stats = data.statistics;
            const statsGrid = document.getElementById('driverStats');
            
            statsGrid.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${stats.totalDrivers}</div>
                    <div class="stat-label">总驱动数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.runningCount}</div>
                    <div class="stat-label">运行中</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.stoppedCount}</div>
                    <div class="stat-label">已停止</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.kernelCount}</div>
                    <div class="stat-label">内核驱动</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.fileSystemCount}</div>
                    <div class="stat-label">文件系统</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.autoStartCount}</div>
                    <div class="stat-label">自动启动</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.thirdPartyCount}</div>
                    <div class="stat-label">第三方</div>
                </div>
            `;
        }

        // 更新驱动表格
        function updateDriverTables(data) {
            updateAllDriversTable(data);
            updateRunningDriversTable(data);
            updateKernelDriversTable(data);
            updateFilesystemDriversTable(data);
            updateAutostartDriversTable(data);
            updateThirdpartyDriversTable(data);
        }

        // 更新全部驱动表格
        function updateAllDriversTable(data) {
            const tbody = document.getElementById('allDriversTableBody');
            const allDrivers = [
                ...data.kernelDrivers,
                ...data.fileSystemDrivers
            ];
            
            tbody.innerHTML = allDrivers.map(driver => `
                <tr>
                    <td class="process-name" title="${driver.name}">${driver.name}</td>
                    <td title="${driver.displayName}">${truncateText(driver.displayName, 25)}</td>
                    <td><span class="process-state ${getDriverStateClass(driver.state)}">${driver.state}</span></td>
                    <td>${driver.driverType || driver.serviceType}</td>
                    <td>${driver.startType}</td>
                    <td title="${driver.binaryPath}">${truncateText(driver.binaryPath, 30)}</td>
                    <td class="process-pid">${driver.pid || '-'}</td>
                    <td>${driver.errorControl || '-'}</td>
                </tr>
            `).join('');
        }

        // 更新运行中驱动表格
        function updateRunningDriversTable(data) {
            const tbody = document.getElementById('runningDriversTableBody');
            
            tbody.innerHTML = data.runningDrivers.map(driver => `
                <tr>
                    <td class="process-name" title="${driver.name}">${driver.name}</td>
                    <td title="${driver.displayName}">${truncateText(driver.displayName, 25)}</td>
                    <td class="process-pid">${driver.pid}</td>
                    <td title="${driver.binaryPath}">${truncateText(driver.binaryPath, 30)}</td>
                    <td>${driver.startType}</td>
                    <td>${driver.driverType || driver.serviceType}</td>
                    <td title="${driver.description || ''}">${truncateText(driver.description || '', 30)}</td>
                </tr>
            `).join('');
        }

        // 更新内核驱动表格
        function updateKernelDriversTable(data) {
            const tbody = document.getElementById('kernelDriversTableBody');
            
            tbody.innerHTML = data.kernelDrivers.map(driver => `
                <tr>
                    <td class="process-name" title="${driver.name}">${driver.name}</td>
                    <td title="${driver.displayName}">${truncateText(driver.displayName, 25)}</td>
                    <td><span class="process-state ${getDriverStateClass(driver.state)}">${driver.state}</span></td>
                    <td>${driver.startType}</td>
                    <td title="${driver.binaryPath}">${truncateText(driver.binaryPath, 30)}</td>
                    <td>${driver.errorControl || '-'}</td>
                    <td title="${driver.description || ''}">${truncateText(driver.description || '', 30)}</td>
                </tr>
            `).join('');
        }

        // 更新文件系统驱动表格
        function updateFilesystemDriversTable(data) {
            const tbody = document.getElementById('filesystemDriversTableBody');
            
            tbody.innerHTML = data.fileSystemDrivers.map(driver => `
                <tr>
                    <td class="process-name" title="${driver.name}">${driver.name}</td>
                    <td title="${driver.displayName}">${truncateText(driver.displayName, 25)}</td>
                    <td><span class="process-state ${getDriverStateClass(driver.state)}">${driver.state}</span></td>
                    <td>${driver.startType}</td>
                    <td title="${driver.binaryPath}">${truncateText(driver.binaryPath, 30)}</td>
                    <td>${driver.errorControl || '-'}</td>
                    <td title="${driver.description || ''}">${truncateText(driver.description || '', 30)}</td>
                </tr>
            `).join('');
        }

        // 更新自动启动驱动表格
        function updateAutostartDriversTable(data) {
            const tbody = document.getElementById('autostartDriversTableBody');
            
            tbody.innerHTML = data.autoStartDrivers.map(driver => `
                <tr>
                    <td class="process-name" title="${driver.name}">${driver.name}</td>
                    <td title="${driver.displayName}">${truncateText(driver.displayName, 25)}</td>
                    <td><span class="process-state ${getDriverStateClass(driver.state)}">${driver.state}</span></td>
                    <td>${driver.startType}</td>
                    <td title="${driver.binaryPath}">${truncateText(driver.binaryPath, 30)}</td>
                    <td>${driver.driverType || driver.serviceType}</td>
                    <td title="${driver.description || ''}">${truncateText(driver.description || '', 30)}</td>
                </tr>
            `).join('');
        }

        // 更新第三方驱动表格
        function updateThirdpartyDriversTable(data) {
            const tbody = document.getElementById('thirdpartyDriversTableBody');
            
            tbody.innerHTML = data.thirdPartyDrivers.map(driver => `
                <tr>
                    <td class="process-name" title="${driver.name}">${driver.name}</td>
                    <td title="${driver.displayName}">${truncateText(driver.displayName, 25)}</td>
                    <td><span class="process-state ${getDriverStateClass(driver.state)}">${driver.state}</span></td>
                    <td>${driver.startType}</td>
                    <td title="${driver.binaryPath}">${truncateText(driver.binaryPath, 40)}</td>
                    <td>${driver.driverType || driver.serviceType}</td>
                    <td class="process-pid">${driver.pid || '-'}</td>
                </tr>
            `).join('');
        }

        // 获取驱动状态对应的CSS类
        function getDriverStateClass(state) {
            switch (state.toLowerCase()) {
                case 'running':
                    return 'state-running';
                case 'stopped':
                    return 'state-stopped';
                case 'start pending':
                    return 'state-pending';
                case 'stop pending':
                    return 'state-pending';
                default:
                    return 'state-unknown';
            }
        }

        // 排序驱动
        function sortDrivers() {
            if (!currentDriversData) return;
            
            const sortBy = document.getElementById('driverSortSelect').value;
            
            // 对每个分类的驱动进行排序
            const sortFunctions = {
                name: (a, b) => a.name.localeCompare(b.name),
                state: (a, b) => a.state.localeCompare(b.state),
                type: (a, b) => (a.driverType || a.serviceType).localeCompare(b.driverType || b.serviceType),
                startType: (a, b) => a.startType.localeCompare(b.startType)
            };
            
            const sortFunction = sortFunctions[sortBy] || sortFunctions.name;
            
            // 更新所有表格
            updateDriverTables({
                ...currentDriversData,
                kernelDrivers: [...currentDriversData.kernelDrivers].sort(sortFunction),
                fileSystemDrivers: [...currentDriversData.fileSystemDrivers].sort(sortFunction),
                runningDrivers: [...currentDriversData.runningDrivers].sort(sortFunction),
                stoppedDrivers: [...currentDriversData.stoppedDrivers].sort(sortFunction),
                autoStartDrivers: [...currentDriversData.autoStartDrivers].sort(sortFunction),
                thirdPartyDrivers: [...currentDriversData.thirdPartyDrivers].sort(sortFunction)
            });
        }

        // 切换显示所有驱动详细信息
        function toggleAllDrivers() {
            driverShowAll = !driverShowAll;
            const btn = event.target;
            
            if (driverShowAll) {
                btn.textContent = '显示简洁信息';
                // 可以在这里展开更多详细信息
                document.querySelectorAll('#driverList .process-table td').forEach(td => {
                    td.style.whiteSpace = 'normal';
                });
            } else {
                btn.textContent = '显示详细信息';
                document.querySelectorAll('#driverList .process-table td').forEach(td => {
                    td.style.whiteSpace = 'nowrap';
                });
            }
        }

        // 工具函数：截断文本
        function truncateText(text, maxLength) {
            if (!text) return '-';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        // 在页面加载时自动加载驱动信息
        document.addEventListener('DOMContentLoaded', function() {
            // 延迟加载驱动信息，避免同时请求过多数据
            setTimeout(loadDriverInfo, 2000);
        });
        // 初始化时加载注册表数据
        loadRegistrySnapshot();
        loadSavedSnapshots();

        // 初始化
        fetchCPUInfo();
        updateCPUUsage();
        loadProcesses();
        loadDiskInfo();
        
        // 定时更新
        setInterval(updateCPUUsage, 1000);
        setInterval(fetchCPUInfo, 30000);
        setInterval(loadProcesses, 5000);
        setInterval(loadDiskInfo, 10000); // 10秒更新一次磁盘信息
    </script>
</body>
</html>