<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统监控面板</title>
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script> -->
    <!-- 引入Tailwind CSS样式库 -->
    <link rel="stylesheet" href="assets/css/tailwind.min.css">
    <!-- 引入anime.js动画库 -->
    <script src="assets/js/anime.min.js"></script>
    <!-- 引入ECharts图表库 -->
    <script src="assets/js/echarts.min.js"></script>
    <!-- 引入自定义字体样式 -->
    <link href="assets/css/fonts.css" rel="stylesheet">
    <style>
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .nav-link.active {
            background-color: #3b82f6;
            color: white;
        }

        .process-table th {
            background-color: #f1f5f9;
        }

        .process-table tr:hover {
            background-color: #f1f5f9;
        }

        .sortable:hover {
            background-color: #e2e8f0 !important;
            cursor: pointer;
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .expandable-content {
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.3s ease;
        }


        /* ===== 1. 设计变量 ===== */
        :root {
            --primary: #3b82f6;
            /* 主色 - 蓝 */
            --secondary: #10b981;
            /* 辅助 - 绿 */
            --danger: #ef4444;
            /* 危险 - 红 */
            --warning: #f59e0b;
            /* 警告 - 橙 */
            --surface: #ffffff;
            /* 卡片底色 */
            --background: #f3f4f6;
            /* 全局背景 */
            --text-main: #111827;
            /* 主文本 */
            --text-second: #6b7280;
            /* 次要文本 */
            --radius: 12px;
            /* 统一圆角 */
            --shadow: 0 4px 14px 0 rgba(0, 0, 0, .08);
            /* 统一卡片阴影 */
            --transition: .25s ease;
        }

        /* ===== 2. 全局微调 ===== */
        body {
            background: var(--background);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        /* ===== 3. 卡片统一 ===== */
        .bg-white.rounded-xl.shadow-md,
        .bg-white.rounded-lg.shadow,
        .bg-white.rounded-lg.shadow-lg {
            border-radius: var(--radius) !important;
            box-shadow: var(--shadow) !important;
            background: var(--surface);
            transition: transform var(--transition), box-shadow var(--transition);
        }

        .bg-white:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px 0 rgba(0, 0, 0, .1) !important;
        }

        /* ===== 4. 按钮统一 ===== */
        button {
            border-radius: calc(var(--radius) / 2);
            font-weight: 500;
            transition: background-color var(--transition), transform var(--transition);
            transform: scale(1);
        }

        button:hover {
            transform: scale(1.03);
        }

        button:active {
            transform: scale(.98);
        }

        /* 主按钮 */
        .bg-blue-500,
        .bg-blue-600 {
            background: var(--primary) !important;
        }

        .bg-blue-500:hover,
        .bg-blue-600:hover {
            background: #2563eb !important;
        }

        /* 成功按钮 */
        .bg-green-500,
        .bg-green-600 {
            background: var(--secondary) !important;
        }

        .bg-green-500:hover,
        .bg-green-600:hover {
            background: #059669 !important;
        }

        /* 危险按钮 */
        .bg-red-500,
        .bg-red-600 {
            background: var(--danger) !important;
        }

        .bg-red-500:hover,
        .bg-red-600:hover {
            background: #dc2626 !important;
        }

        /* ===== 5. 表格统一 ===== */
        table {
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        th {
            background: #f9fafb;
            color: var(--text-second);
            font-weight: 600;
            letter-spacing: .4px;
        }

        tr:hover {
            background: #f9fafb !important;
        }

        td,
        th {
            padding: .75rem 1rem !important;
        }

        /* ===== 6. 进度条/图表容器 ===== */
        .rounded-full {
            border-radius: 9999px;
        }

        .bg-gray-200 {
            background: #e5e7eb;
        }

        .bg-blue-600,
        .bg-green-600,
        .bg-purple-600 {
            background: var(--primary) !important;
        }

        /* 图表区域统一留白 */
        #historyUsageChart,
        #cpuUsageGauge,
        #memoryUsageGauge,
        #driverTypeChart,
        #cpuHistoryChart,
        #memoryHistoryChart,
        [id^="diskUsageChart-"],
        [id^="diskPerformanceChart-"] {
            border-radius: var(--radius);
            background: var(--surface);
            padding: .5rem;
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- 侧边栏 -->
        <div class="w-64 bg-white shadow-lg">
            <div class="p-4 border-b">
                <h1 class="text-xl font-bold text-gray-800">系统监控面板</h1>
            </div>
            <nav class="p-2">
                <ul>

                    <li class="mb-1">
                        <button class="w-full text-left px-4 py-3 rounded-lg nav-link active"
                            data-tab="snapshot">快照信息</button>
                    </li>
                    <li class="mb-1">
                        <button class="w-full text-left px-4 py-3 rounded-lg nav-link " data-tab="home">性能概览</button>
                    </li>
                    <li class="mb-1">
                        <button class="w-full text-left px-4 py-3 rounded-lg nav-link" data-tab="registry">注册表</button>
                    </li>
                    <li class="mb-1">
                        <button class="w-full text-left px-4 py-3 rounded-lg nav-link" data-tab="cpu">CPU信息</button>
                    </li>
                    <li class="mb-1">
                        <button class="w-full text-left px-4 py-3 rounded-lg nav-link" data-tab="memory">内存信息</button>
                    </li>
                    <li class="mb-1">
                        <button class="w-full text-left px-4 py-3 rounded-lg nav-link" data-tab="disk">硬盘信息</button>
                    </li>
                    <li class="mb-1">
                        <button class="w-full text-left px-4 py-3 rounded-lg nav-link" data-tab="process">进程信息</button>
                    </li>
                    <li class="mb-1">
                        <button class="w-full text-left px-4 py-3 rounded-lg nav-link" data-tab="driver">驱动信息</button>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- 主内容区 -->
        <div class="flex-1 overflow-auto">
            <!-- 首页 -->
            <div id="home" class="tab-content p-6">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">系统概览</h2>

                <!-- 统计数据卡片网格（一行四列） -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <!-- 运行进程数 -->
                    <div class="bg-white rounded-xl shadow-md p-6 cursor-pointer transition-all duration-300 hover:shadow-lg hover:border-blue-300 border border-gray-100"
                        onclick="switchTab('process')">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 mr-4">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                                    </path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">运行进程数</p>
                                <p class="text-2xl font-bold text-gray-800" id="processCountValue">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- 系统快照数量 -->
                    <div class="bg-white rounded-xl shadow-md p-6 cursor-pointer transition-all duration-300 hover:shadow-lg hover:border-green-300 border border-gray-100"
                        onclick="switchTab('snapshot')">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 mr-4">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">系统快照数量</p>
                                <p class="text-2xl font-bold text-gray-800" id="systemSnapshotCount">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- 注册表快照数量 -->
                    <div class="bg-white rounded-xl shadow-md p-6 cursor-pointer transition-all duration-300 hover:shadow-lg hover:border-purple-300 border border-gray-100"
                        onclick="switchTab('registry')">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100 mr-4">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4">
                                    </path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">注册表快照数量</p>
                                <p class="text-2xl font-bold text-gray-800" id="registrySnapshotCount">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- 驱动总数 -->
                    <div class="bg-white rounded-xl shadow-md p-6 cursor-pointer transition-all duration-300 hover:shadow-lg hover:border-yellow-300 border border-gray-100"
                        onclick="switchTab('driver')">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-yellow-100 mr-4">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01">
                                    </path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">驱动总数</p>
                                <p class="text-2xl font-bold text-gray-800" id="driverCountValue">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 原有的概览卡片网格 -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <!-- CPU使用率卡片 -->
                    <div class="bg-white rounded-xl shadow-md p-6 cursor-pointer transition-all duration-300 hover:shadow-lg hover:border-blue-300 border border-gray-100"
                        onclick="switchTab('cpu')">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 mr-4">
                                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z">
                                    </path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">CPU使用率</p>
                                <p class="text-2xl font-bold text-gray-800" id="cpuUsageValue">0%</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="cpuUsageBar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 内存使用情况卡片 -->
                    <div class="bg-white rounded-xl shadow-md p-6 cursor-pointer transition-all duration-300 hover:shadow-lg hover:border-green-300 border border-gray-100"
                        onclick="switchTab('memory')">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 mr-4">
                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z">
                                    </path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">内存使用率</p>
                                <p class="text-2xl font-bold text-gray-800" id="memoryUsageValue">0 GB / 0 GB</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="memoryUsageBar" class="bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 磁盘使用情况卡片 -->
                    <div class="bg-white rounded-xl shadow-md p-6 cursor-pointer transition-all duration-300 hover:shadow-lg hover:border-purple-300 border border-gray-100"
                        onclick="switchTab('disk')">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100 mr-4">
                                <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01">
                                    </path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">磁盘使用情况</p>
                                <p class="text-2xl font-bold text-gray-800" id="diskUsageValue">0%</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="diskUsageBar" class="bg-purple-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>


                </div>


                <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4z">
                                </path>
                            </svg>
                            CPU & 内存历史使用率趋势
                        </h3>
                        <!-- 实时指示器 -->
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center">
                                <div id="cpuLiveIndicator" class="w-3 h-3 bg-green-400 rounded-full mr-2 animate-pulse">
                                </div>
                                <span class="text-sm text-gray-600">CPU 实时</span>
                            </div>
                            <div class="flex items-center">
                                <div id="memoryLiveIndicator"
                                    class="w-3 h-3 bg-purple-400 rounded-full mr-2 animate-pulse"></div>
                                <span class="text-sm text-gray-600">内存 实时</span>
                            </div>
                            <div class="text-xs text-gray-500">
                                更新间隔: <span id="updateInterval">2秒</span>
                            </div>
                        </div>
                    </div>

                    <!-- 图表容器 -->
                    <div class="h-80" id="historyUsageChart"></div>

                    <!-- 底部图例和信息 -->
                    <div class="mt-4 flex justify-between items-center text-sm text-gray-600">
                        <div class="flex items-center space-x-6">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                                <span>CPU 使用率 (%)</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                                <span>内存 使用率 (%)</span>
                            </div>
                        </div>
                        <div class="text-xs text-gray-400">
                            数据范围: 最近30分钟 | 时间格式: HH:MM:SS
                        </div>
                    </div>
                </div>
            </div>

            <!-- 快照信息 -->
            <div id="snapshot" class="tab-content active p-6">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">系统快照信息</h2>

                <!-- 创建系统快照 -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">创建系统快照</h3>
                    </div>
                    <div class="flex items-center space-x-4">
                        <input type="text" id="snapshotNameInput" placeholder="输入快照名称（可选）"
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="createSystemSnapshotBtn"
                            class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center">
                            <span>创建快照</span>
                        </button>
                    </div>
                    <div id="snapshotStatus" class="hidden mt-4 p-3 rounded-lg">
                        <p class="text-green-600">快照 "<span id="snapshotNameDisplay"></span>" 创建成功!</p>
                    </div>
                </div>

                <!-- 系统快照列表 -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">系统快照列表（选择两个开始比较）</h3>
                        <!-- <button id="refreshSnapshotBtn"
                            class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                            刷新
                        </button> -->
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full process-table">
                            <thead>
                                <tr>
                                    <th class="py-2 px-4 text-left w-1/12">
                                        <input type="checkbox" id="selectAllCheckbox"
                                            class="form-checkbox h-4 w-4 text-blue-600">
                                    </th>
                                    <th class="py-2 px-4 text-left">快照名称</th>
                                    <th class="py-2 px-4 text-left">创建时间</th>
                                    <th class="py-2 px-4 text-left">操作</th>
                                </tr>
                            </thead>
                            <tbody id="systemSnapshotTableBody">
                                <tr>
                                    <td colspan="4" class="py-4 text-center text-gray-500">
                                        加载中...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 对比选中快照按钮 -->
                    <div class="mt-4">
                        <button id="compareSelectedSnapshotsBtn"
                            class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors hidden flex items-center">
                            <span>开始对比</span>
                        </button>
                    </div>
                </div>

                <!-- 系统快照对比结果 -->
                <div id="systemComparisonResult" class="bg-white rounded-lg shadow p-6 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">快照对比结果</h3>
                        <button id="closeComparisonBtn" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12">
                                </path>
                            </svg>
                        </button>
                    </div>
                    <div id="systemComparisonContent" class="bg-gray-50 rounded-lg p-4">
                        <!-- 对比结果将在这里显示 -->
                    </div>
                </div>
            </div>

            <!-- 注册表 -->
            <!-- 替换原有的注册表部分 -->
            <div id="registry" class="tab-content p-6">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">注册表信息</h2>

                <!-- 保存注册表快照区域 -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">注册表快照管理</h3>
                        <button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg"
                            id="saveRegistryBtn">
                            保存注册表快照
                        </button>
                    </div>

                    <!-- 状态显示区域 -->
                    <div id="registryStatus" class="hidden p-4 rounded-lg mb-4">
                        <div class="flex items-center">
                            <span id="statusIcon" class="mr-2"></span>
                            <span id="statusText" class="font-medium"></span>
                            <span id="backupDir" class="ml-2 text-gray-600"></span>
                        </div>
                    </div>
                </div>

                <!-- 注册表快照列表 -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">注册表快照列表</h3>
                        <button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg"
                            id="refreshRegistryBtn">
                            刷新
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full process-table">
                            <thead>
                                <tr>
                                    <th class="py-2 px-4 text-left">文件夹名称</th>
                                    <th class="py-2 px-4 text-left">创建时间</th>
                                    <th class="py-2 px-4 text-left">总大小</th>
                                    <th class="py-2 px-4 text-left">文件数量</th>
                                    <th class="py-2 px-4 text-left">操作</th>
                                </tr>
                            </thead>
                            <tbody id="registryTableBody">
                                <tr>
                                    <td colspan="5" class="py-4 text-center text-gray-500">
                                        加载中...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 注册表快照对比 -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">注册表快照对比</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block mb-2">快照1</label>
                            <select class="w-full p-2 border rounded-lg" id="registrySnapshot1">
                                <option value="">请选择快照</option>
                            </select>
                        </div>
                        <div>
                            <label class="block mb-2">快照2</label>
                            <select class="w-full p-2 border rounded-lg" id="registrySnapshot2">
                                <option value="">请选择快照</option>
                            </select>
                        </div>
                    </div>

                    <div class="mt-4">
                        <button class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg"
                            id="compareRegistryBtn">
                            对比注册表快照
                        </button>
                    </div>

                    <!-- 对比结果 -->
                    <div id="registryComparisonResult" class="hidden mt-6">
                        <h4 class="font-medium mb-4">对比结果</h4>

                        <!-- 总览统计 -->
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                            <div class="p-4 bg-blue-50 rounded-lg text-center">
                                <p class="text-2xl font-bold text-blue-700" id="totalComparedFiles">0</p>
                                <p class="text-sm text-gray-600">对比文件数</p>
                            </div>
                            <div class="p-4 bg-green-50 rounded-lg text-center">
                                <p class="text-2xl font-bold text-green-700" id="totalAddedKeys">0</p>
                                <p class="text-sm text-gray-600">新增键数</p>
                            </div>
                            <div class="p-4 bg-red-50 rounded-lg text-center">
                                <p class="text-2xl font-bold text-red-700" id="totalRemovedKeys">0</p>
                                <p class="text-sm text-gray-600">删除键数</p>
                            </div>
                            <div class="p-4 bg-yellow-50 rounded-lg text-center">
                                <p class="text-2xl font-bold text-yellow-700" id="totalModifiedKeys">0</p>
                                <p class="text-sm text-gray-600">修改键数</p>
                            </div>
                            <div class="p-4 bg-purple-50 rounded-lg text-center">
                                <p class="text-2xl font-bold text-purple-700" id="uniqueFiles">0</p>
                                <p class="text-sm text-gray-600">独有文件</p>
                            </div>
                        </div>

                        <!-- 文件对比详情 -->
                        <div class="mb-6">
                            <h5 class="font-medium mb-2">文件对比详情</h5>
                            <div class="overflow-x-auto">
                                <table class="min-w-full process-table">
                                    <thead>
                                        <tr>
                                            <th class="py-2 px-4 text-left sortable" data-sort="prefix">前缀</th>
                                            <th class="py-2 px-4 text-left">文件1</th>
                                            <th class="py-2 px-4 text-left">文件2</th>
                                            <th class="py-2 px-4 text-left">新增键</th>
                                            <th class="py-2 px-4 text-left">删除键</th>
                                            <th class="py-2 px-4 text-left">修改键</th>
                                        </tr>
                                    </thead>
                                    <tbody id="comparisonFilesTable">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 详细变更信息 -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="p-4 bg-green-50 rounded-lg">
                                <h5 class="font-medium text-green-700 mb-2">新增键详情</h5>
                                <ul class="text-sm max-h-40 overflow-y-auto" id="addedKeysDetails"></ul>
                            </div>
                            <div class="p-4 bg-red-50 rounded-lg">
                                <h5 class="font-medium text-red-700 mb-2">删除键详情</h5>
                                <ul class="text-sm max-h-40 overflow-y-auto" id="removedKeysDetails"></ul>
                            </div>
                            <div class="p-4 bg-yellow-50 rounded-lg">
                                <h5 class="font-medium text-yellow-700 mb-2">修改键详情</h5>
                                <ul class="text-sm max-h-40 overflow-y-auto" id="modifiedKeysDetails"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CPU信息 -->
            <div id="cpu" class="tab-content p-6">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">CPU信息</h2>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">CPU当前使用率</h3>
                            <!-- CPU监控控制 -->
                            <div class="flex items-center space-x-2">
                                <button id="cpuRefreshToggle"
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                                    暂停刷新
                                </button>
                                <div class="flex items-center">
                                    <label class="mr-1 text-sm">间隔:</label>
                                    <select id="cpuRefreshInterval" class="p-1 border rounded text-sm">
                                        <option value="1000" selected>1秒</option>
                                        <option value="3000">3秒</option>
                                        <option value="10000">10秒</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="flex">
                            <div class="h-64 flex-1" id="cpuUsageGauge"></div>
                            <div class="flex items-center justify-center w-32">
                                <div id="cpuStatus" class="text-center">
                                    <p class="text-lg font-semibold" id="cpuStatusText">良好</p>
                                    <p class="text-sm text-gray-500" id="cpuStatusDescription">CPU使用率正常</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">CPU详细信息</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full process-table">
                                <tbody id="cpuInfoTable">
                                    <tr>
                                        <td colspan="2" class="py-4 text-center text-gray-500">
                                            加载中...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">CPU历史使用率</h3>
                    <div class="h-80" id="cpuHistoryChart"></div>
                </div>
            </div>

            <!-- 内存信息 -->
            <div id="memory" class="tab-content p-6">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">内存信息</h2>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">内存使用情况</h3>
                            <!-- 内存监控控制 -->
                            <div class="flex items-center space-x-2">
                                <button id="memoryRefreshToggle"
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                                    暂停刷新
                                </button>
                                <div class="flex items-center">
                                    <label class="mr-1 text-sm">间隔:</label>
                                    <select id="memoryRefreshInterval" class="p-1 border rounded text-sm">
                                        <option value="1000">1秒</option>
                                        <option value="2000" selected>2秒</option>
                                        <option value="5000">5秒</option>
                                        <option value="10000">10秒</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="flex">
                            <div class="h-64 flex-1" id="memoryUsageGauge"></div>
                            <div class="flex items-center justify-center w-32">
                                <div id="memoryStatus" class="text-center">
                                    <p class="text-lg font-semibold" id="memoryStatusText">良好</p>
                                    <p class="text-sm text-gray-500" id="memoryStatusDescription">内存使用率正常</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">内存详细信息</h3>
                        <div class="space-y-4">
                            <div>
                                <p class="text-gray-600">总内存</p>
                                <p class="text-xl font-semibold" id="totalMemory">-</p>
                            </div>
                            <div>
                                <p class="text-gray-600">已用内存</p>
                                <p class="text-xl font-semibold" id="usedMemory">-</p>
                            </div>
                            <div>
                                <p class="text-gray-600">可用内存</p>
                                <p class="text-xl font-semibold" id="availableMemory">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">内存历史使用率</h3>
                    <div class="h-80" id="memoryHistoryChart"></div>
                </div>
            </div>

            <!-- 硬盘信息 -->
            <div id="disk" class="tab-content p-6">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">硬盘信息</h2>

                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">硬盘列表</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full process-table">
                            <thead>
                                <tr>
                                    <th class="py-2 px-4 text-left">设备ID</th>
                                    <th class="py-2 px-4 text-left">型号</th>
                                    <th class="py-2 px-4 text-left">总大小</th>
                                    <th class="py-2 px-4 text-left">已用空间</th>
                                    <th class="py-2 px-4 text-left">可用空间</th>
                                    <th class="py-2 px-4 text-left">使用率</th>
                                </tr>
                            </thead>
                            <tbody id="diskTableBody">
                                <tr>
                                    <td colspan="6" class="py-4 text-center text-gray-500">
                                        加载中...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 添加磁盘使用情况饼图区域 -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">磁盘使用情况</h3>
                    </div>
                    <div id="diskUsageCharts" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>

                <!-- 修改硬盘性能部分 -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">硬盘读写速度</h3>
                        <!-- 硬盘监控控制 -->
                        <div class="flex items-center space-x-2">
                            <button id="diskRefreshToggle"
                                class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                                暂停刷新
                            </button>
                            <div class="flex items-center">
                                <label class="mr-1 text-sm">间隔:</label>
                                <select id="diskRefreshInterval" class="p-1 border rounded text-sm">
                                    <option value="1000">1秒</option>
                                    <option value="2000" selected>2秒</option>
                                    <option value="5000">5秒</option>
                                    <option value="10000">10秒</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div id="diskPerformanceCharts" class="grid grid-cols-1 gap-4"></div>
                </div>
            </div>

            <!-- 进程信息 -->
            <!-- 修改进程信息部分 -->
            <div id="process" class="tab-content p-6">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">进程信息</h2>

                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex items-center space-x-4">
                            <div class="text-lg">
                                总进程数: <span id="totalProcessCount" class="font-semibold">0</span>
                            </div>
                            <div class="text-lg">
                                总线程数: <span id="totalThreadCount" class="font-semibold">0</span>
                            </div>
                            <div class="text-lg">
                                句柄数: <span id="totalHandleCount" class="font-semibold">0</span>
                            </div>
                            <div class="text-lg">
                                GDI对象: <span id="totalGdiCount" class="font-semibold">0</span>
                            </div>
                            <div class="text-lg">
                                USER对象: <span id="totalUserCount" class="font-semibold">0</span>
                            </div>
                        </div>

                        <div class="flex items-center space-x-4">
                            <div class="flex items-center">
                                <label class="mr-2 text-sm">显示数量:</label>
                                <select id="processDisplayCount" class="p-1 border rounded text-sm">
                                    <option value="20">20条</option>
                                    <option value="50" selected>50条</option>
                                    <option value="100">100条</option>
                                    <option value="all">全部</option>
                                </select>
                            </div>

                            <div class="flex items-center">
                                <button id="processRefreshToggle"
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                                    暂停刷新
                                </button>
                                <div class="flex items-center ml-2">
                                    <label class="mr-1 text-sm">间隔:</label>
                                    <select id="processRefreshInterval" class="p-1 border rounded text-sm">
                                        <option value="1000">1秒</option>
                                        <option value="2000" selected>2秒</option>
                                        <option value="5000">5秒</option>
                                        <option value="10000">10秒</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">进程列表</h3>
                        <div>
                            <input type="text" placeholder="搜索进程..." class="p-2 border rounded-lg" id="processSearch">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full process-table">
                            <thead>
                                <tr>
                                    <th class="py-2 px-4 text-left sortable" data-sort="name">进程名 ↑↓</th>
                                    <th class="py-2 px-4 text-left sortable" data-sort="pid">PID ↑↓</th>
                                    <th class="py-2 px-4 text-left sortable" data-sort="cpu">CPU使用率 ↑↓</th>
                                    <th class="py-2 px-4 text-left sortable" data-sort="memory">内存使用 ↑↓</th>
                                    <th class="py-2 px-4 text-left">线程数</th>
                                    <th class="py-2 px-4 text-left">句柄数</th>
                                    <th class="py-2 px-4 text-left">GDI对象</th>
                                    <th class="py-2 px-4 text-left">USER对象</th>
                                    <th class="py-2 px-4 text-left">状态</th>
                                    <th class="py-2 px-4 text-left">操作</th>
                                </tr>
                            </thead>
                            <tbody id="processListTableBody">
                                <tr>
                                    <td colspan="7" class="py-4 text-center text-gray-500">
                                        加载中...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 进程详情模态窗口 -->
            <div id="processDetailModal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                <div class="bg-white rounded-lg shadow-lg w-1/2 max-h-[90vh] overflow-y-auto">
                    <div class="border-b p-4 flex justify-between items-center">
                        <h3 class="text-lg font-semibold">进程详情</h3>
                        <button id="closeProcessDetailModal" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12">
                                </path>
                            </svg>
                        </button>
                    </div>
                    <div class="p-6" id="processDetailContent">
                        <!-- 进程详情内容将在这里显示 -->
                    </div>
                </div>
            </div>

            <!-- 驱动信息 -->
            <!-- 驱动信息 -->
            <div id="driver" class="tab-content p-6">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">驱动信息</h2>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <!-- 驱动统计内容保持不变 -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">驱动统计</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between">
                                <span>总驱动数</span>
                                <span class="font-semibold" id="totalDrivers">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span>运行中</span>
                                <span class="font-semibold text-green-600" id="runningDrivers">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span>已停止</span>
                                <span class="font-semibold text-red-600" id="stoppedDrivers">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span>内核驱动</span>
                                <span class="font-semibold" id="kernelDrivers">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span>文件系统</span>
                                <span class="font-semibold" id="fileSystemDrivers">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span>自启动</span>
                                <span class="font-semibold" id="autoStartDrivers">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span>第三方驱动</span>
                                <span class="font-semibold" id="thirdPartyDrivers">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6 lg:col-span-2">
                        <h3 class="text-lg font-semibold mb-4">驱动类型分布</h3>
                        <div class="h-48" id="driverTypeChart"></div>
                    </div>
                </div>

                <!-- 驱动列表 -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                        <div class="flex items-center space-x-2">
                            <div class="flex items-center">
                                <select id="driverFilter" class="p-1 border rounded text-sm">
                                    <option value="all">全部</option>
                                    <option value="running">运行中</option>
                                    <option value="stopped">已停止</option>
                                    <!-- <option value="kernel">内核驱动</option>
                                    <option value="filesystem">文件系统</option>
                                    <option value="autostart">自动启动</option>
                                    <option value="thirdparty">第三方驱动</option> -->
                                </select>
                            </div>
                            <button id="refreshDriversBtn"
                                class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                                刷新
                            </button>
                        </div>

                        <!-- 添加显示数量选择和刷新控制 -->
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center">
                                <label class="mr-2 text-sm">显示数量:</label>
                                <select id="driverDisplayCount" class="p-1 border rounded text-sm">
                                    <option value="20">20条</option>
                                    <option value="50" selected>50条</option>
                                    <option value="100">100条</option>
                                    <option value="all">全部</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full process-table">
                            <thead>
                                <tr>
                                    <th class="py-2 px-4 text-left sortable-driver w-1/6" data-sort="name">驱动名称 ▼</th>
                                    <th class="py-2 px-4 text-left sortable-driver w-1/6" data-sort="displayName">显示名称 ▼
                                    </th>
                                    <th class="py-2 px-4 text-left sortable-driver w-1/12" data-sort="state">状态 ▼</th>
                                    <th class="py-2 px-4 text-left sortable-driver w-1/12" data-sort="startType">启动类型 ▼
                                    </th>
                                    <th class="py-2 px-4 text-left sortable-driver w-1/12" data-sort="driverType">类型 ▼
                                    </th>
                                    <th class="py-2 px-4 text-left w-3/12 truncate">路径</th>
                                </tr>
                            </thead>
                            <tbody id="driverTableBody">
                                <tr>
                                    <td colspan="6" class="py-4 text-center text-gray-500">
                                        加载中...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 当前活动的标签
        let activeTab = 'home';


        // 初始化图表
        let charts = {};

        // 快照相关变量
        let systemSnapshots = [];

        // 添加新变量来跟踪选中的快照
        let selectedSnapshots = [];

        // 进程排序状态
        let processSort = {
            field: 'pid',
            direction: 'asc'
        };

        // CPU监控相关变量
        let cpuRefreshInterval = 1000; // 默认1秒
        let cpuRefreshEnabled = true;
        let cpuRefreshTimer = null;

        // 内存监控相关变量
        let memoryRefreshInterval = 2000; // 默认2秒
        let memoryRefreshEnabled = true;
        let memoryRefreshTimer = null;

        // 硬盘监控相关变量
        let diskRefreshInterval = 2000; // 默认2秒
        let diskRefreshEnabled = true;
        let diskRefreshTimer = null;
        let diskCharts = {}; // 存储磁盘图表实例

        // 进程监控相关变量
        let processRefreshInterval = 2000; // 默认2秒
        let processRefreshEnabled = true;
        let processRefreshTimer = null;
        let processDisplayCount = 50; // 默认显示50条

        let driverDisplayCount = 50;
        // 添加驱动排序状态
        let driverSort = {
            field: 'name',
            direction: 'asc'
        };

        // 添加驱动过滤状态
        let driverFilter = 'all';

        // API基础URL
        const API_BASE = '/api';

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function () {
            // 设置标签切换事件
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function () {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            // 初始化首页图表
            initHomeCharts();

            // 绑定事件
            bindEvents();

            // 加载首页数据
            loadDashboardData();
            loadOverviewData();

            initSnapshotFunctionality();

            // 初始化进程相关事件
            bindProcessEvents();

            // 启动进程数据自动刷新（如果已启用）
            if (processRefreshEnabled) {
                startProcessRefresh();
            }

            // 驱动筛选事件
            document.getElementById('driverFilter').addEventListener('change', function () {
                driverFilter = this.value;
                loadDriverData();
            });

            // 手动刷新驱动列表
            document.getElementById('refreshDriversBtn').addEventListener('click', loadDriverData);

            // 驱动排序事件
            document.querySelectorAll('.sortable-driver').forEach(th => {
                th.addEventListener('click', function () {
                    const field = this.getAttribute('data-sort');
                    sortDriversBy(field);
                });
            });

            document.getElementById('driverDisplayCount').addEventListener('change', function () {
                const value = this.value;
                driverDisplayCount = value === 'all' ? Infinity : parseInt(value);
                loadDriverData();
            });


            // 注册表相关事件绑定
            document.getElementById('saveRegistryBtn').addEventListener('click', saveRegistrySnapshot);
            document.getElementById('refreshRegistryBtn').addEventListener('click', loadRegistryData);
            document.getElementById('compareRegistryBtn').addEventListener('click', compareRegistrySnapshots);
            startHistoryRefresh();

        });

        // 绑定事件
        function bindEvents() {
            // 快照相关事件
            // document.getElementById('createSnapshotBtn').addEventListener('click', createSnapshot);
            //document.getElementById('compareBtn').addEventListener('click', compareSnapshots);

            // 注册表相关事件
            document.getElementById('refreshRegistryBtn').addEventListener('click', loadRegistryData);

            // 进程搜索事件
            document.getElementById('processSearch').addEventListener('input', function () {
                loadProcessData(this.value);
            });

            // 进程排序事件
            document.querySelectorAll('.sortable').forEach(th => {
                th.addEventListener('click', function () {
                    const field = this.getAttribute('data-sort');
                    sortProcesses(field);
                });
            });

            // CPU监控控制事件
            document.getElementById('cpuRefreshToggle').addEventListener('click', toggleCpuRefresh);
            document.getElementById('cpuRefreshInterval').addEventListener('change', changeCpuRefreshInterval);

            // 内存监控控制事件
            document.getElementById('memoryRefreshToggle').addEventListener('click', toggleMemoryRefresh);
            document.getElementById('memoryRefreshInterval').addEventListener('change', changeMemoryRefreshInterval);

            // 硬盘监控控制事件
            document.getElementById('diskRefreshToggle').addEventListener('click', toggleDiskRefresh);
            document.getElementById('diskRefreshInterval').addEventListener('change', changeDiskRefreshInterval);
        }

        // 切换标签
        function switchTab(tabId) {
            // 隐藏所有标签内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // 移除所有导航链接的活动状态
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // 显示目标标签内容
            document.getElementById(tabId).classList.add('active');

            // 设置导航链接为活动状态
            document.querySelector(`.nav-link[data-tab="${tabId}"]`).classList.add('active');

            // 根据标签初始化相应内容
            switch (tabId) {
                case 'cpu':
                    initCpuCharts();
                    loadCpuData();
                    if (cpuRefreshEnabled) {
                        startCpuRefresh();
                    }
                    break;
                case 'memory':
                    initMemoryCharts();
                    loadMemoryData();
                    if (memoryRefreshEnabled) {
                        startMemoryRefresh();
                    }
                    break;
                case 'disk':
                    initDiskCharts();
                    loadDiskData();
                    if (diskRefreshEnabled) {
                        startDiskRefresh();
                    }
                    break;
                case 'process':
                    loadProcessData();
                    break;
                case 'driver':
                    initDriverCharts();
                    loadDriverData();
                    break;
                case 'snapshot':
                    // loadSnapshotData();
                    loadSystemSnapshotData();
                    break;
                case 'registry':
                    loadRegistryData();
                    break;
            }

            activeTab = tabId;
        }

        // 初始化首页图表
        function initHomeCharts() {

            if (!charts.historyUsageChart) {
                charts.historyUsageChart = echarts.init(document.getElementById('historyUsageChart'));
                charts.historyUsageChart.setOption({
                    backgroundColor: 'transparent',
                    title: {
                        show: false
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross',
                            animation: false,
                            label: {
                                backgroundColor: '#6a7985'
                            }
                        },
                        formatter: function (params) {
                            let result = '<div class="text-sm font-medium mb-2">' +
                                new Date(params[0].value[0]).toLocaleTimeString() + '</div>';
                            params.forEach(function (item) {
                                const color = item.seriesName === 'CPU使用率' ? '#3b82f6' : '#10b981';
                                result += `<div class="flex items-center mb-1">
                        <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${color}"></span>
                        <span class="font-medium">${item.seriesName}:</span>
                        <span class="ml-2">${item.value[1].toFixed(2)}%</span>
                    </div>`;
                            });
                            return result;
                        },
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        borderColor: '#e5e7eb',
                        borderWidth: 1,
                        textStyle: {
                            color: '#374151'
                        },
                        extraCssText: 'box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); border-radius: 0.5rem;'
                    },
                    legend: {
                        data: ['CPU使用率', '内存使用率'],
                        top: 10,
                        right: 20,
                        textStyle: {
                            fontSize: 12,
                            color: '#6b7280'
                        },
                        itemWidth: 12,
                        itemHeight: 12,
                        itemGap: 20
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        top: '15%',
                        containLabel: true,
                        backgroundColor: 'transparent'
                    },
                    xAxis: {
                        type: 'time',
                        boundaryGap: false,
                        axisLine: {
                            lineStyle: {
                                color: '#e5e7eb'
                            }
                        },
                        axisTick: {
                            show: false
                        },
                        axisLabel: {
                            color: '#6b7280',
                            fontSize: 11,
                            formatter: function (value) {
                                return new Date(value).toLocaleTimeString();
                            }
                        },
                        splitLine: {
                            show: true,
                            lineStyle: {
                                color: '#f3f4f6',
                                type: 'dashed'
                            }
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: '使用率 (%)',
                        nameTextStyle: {
                            color: '#6b7280',
                            fontSize: 12
                        },
                        axisLine: {
                            show: false
                        },
                        axisTick: {
                            show: false
                        },
                        axisLabel: {
                            color: '#6b7280',
                            fontSize: 11,
                            formatter: '{value}%'
                        },
                        splitLine: {
                            lineStyle: {
                                color: '#f3f4f6',
                                type: 'dashed'
                            }
                        },
                        min: 0,
                        max: 100
                    },
                    series: [
                        {
                            name: 'CPU使用率',
                            type: 'line',
                            smooth: true,
                            symbol: 'circle',
                            symbolSize: 6,
                            sampling: 'average',
                            itemStyle: {
                                color: '#3b82f6'
                            },
                            lineStyle: {
                                width: 3,
                                color: '#3b82f6'
                            },
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: 'rgba(59, 130, 246, 0.3)' },
                                    { offset: 1, color: 'rgba(59, 130, 246, 0.05)' }
                                ])
                            },
                            data: []
                        },
                        {
                            name: '内存使用率',
                            type: 'line',
                            smooth: true,
                            symbol: 'circle',
                            symbolSize: 6,
                            sampling: 'average',
                            itemStyle: {
                                color: '#10b981'
                            },
                            lineStyle: {
                                width: 3,
                                color: '#10b981'
                            },
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: 'rgba(16, 185, 129, 0.3)' },
                                    { offset: 1, color: 'rgba(16, 185, 129, 0.05)' }
                                ])
                            },
                            data: []
                        }
                    ],
                    animationDuration: 1000,
                    animationEasing: 'cubicOut'
                });
            }

            setTimeout(() => {
                charts.historyUsageChart.resize();
            }, 100);
        }

        function loadHistoryUsageData() {
            Promise.all([
                fetch(`${API_BASE}/cpu/history`).then(res => res.json()),
                fetch(`${API_BASE}/memory/history`).then(res => res.json())
            ]).then(([cpuData, memoryData]) => {
                // 转换数据格式
                const cpuSeriesData = cpuData.map(item => [item.timestamp, item.value]);
                const memorySeriesData = memoryData.map(item => [item.timestamp, item.value]);

                // 更新图表
                charts.historyUsageChart.setOption({
                    series: [
                        {
                            data: cpuSeriesData
                        },
                        {
                            data: memorySeriesData
                        }
                    ]
                });

                // 更新实时指示器
                updateLiveIndicators();
            }).catch(err => {
                console.error('加载历史使用率数据失败:', err);
                // 显示错误状态
                document.getElementById('historyUsageChart').innerHTML = `
            <div class="flex items-center justify-center h-full">
                <div class="text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0118 12M6 20.291A7.962 7.962 0 016 12m0 8.291A7.962 7.962 0 016 12m0-8.291A7.962 7.962 0 016 12m0 8.291A7.962 7.962 0 016 12m0-8.291A7.962 7.962 0 016 12" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">数据加载失败</h3>
                    <p class="mt-1 text-sm text-gray-500">请检查网络连接或稍后重试</p>
                    <button onclick="loadHistoryUsageData()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        重新加载
                    </button>
                </div>
            </div>
        `;
            });
        }

        // 新增：更新实时指示器状态
        function updateLiveIndicators() {
            const cpuIndicator = document.getElementById('cpuLiveIndicator');
            const memoryIndicator = document.getElementById('memoryLiveIndicator');

            // 模拟实时状态（可以根据实际数据更新）
            const cpuStatus = Math.random() > 0.7 ? 'bg-red-400' : 'bg-green-400';
            const memoryStatus = Math.random() > 0.8 ? 'bg-red-400' : 'bg-green-400';

            cpuIndicator.className = `w-3 h-3 ${cpuStatus} rounded-full mr-2 animate-pulse`;
            memoryIndicator.className = `w-3 h-3 ${memoryStatus} rounded-full mr-2 animate-pulse`;
        }

        // 新增：自动刷新历史数据
        let historyRefreshTimer = null;

        function startHistoryRefresh() {
            stopHistoryRefresh();
            historyRefreshTimer = setInterval(() => {
                if (activeTab === 'home') {
                    loadHistoryUsageData();
                }
            }, 2000); // 2秒刷新一次
        }

        function stopHistoryRefresh() {
            if (historyRefreshTimer) {
                clearInterval(historyRefreshTimer);
                historyRefreshTimer = null;
            }
        }


        // 初始化CPU图表
        function initCpuCharts() {
            if (!charts.cpuUsageGauge) {
                charts.cpuUsageGauge = echarts.init(document.getElementById('cpuUsageGauge'));
                charts.cpuUsageGauge.setOption({
                    series: [
                        {
                            type: 'gauge',
                            progress: {
                                show: true,
                                width: 18
                            },
                            axisLine: {
                                lineStyle: {
                                    width: 18
                                }
                            },
                            axisTick: {
                                show: false
                            },
                            splitLine: {
                                length: 15,
                                lineStyle: {
                                    width: 2,
                                    color: '#999'
                                }
                            },
                            axisLabel: {
                                distance: 25,
                                color: '#999',
                                fontSize: 10
                            },
                            anchor: {
                                show: true,
                                showAbove: true,
                                size: 25,
                                itemStyle: {
                                    borderWidth: 10
                                }
                            },
                            title: {
                                show: false
                            },
                            detail: {
                                valueAnimation: true,
                                fontSize: 20,
                                formatter: '{value}%'
                            },
                            data: [
                                {
                                    value: 0
                                }
                            ]
                        }
                    ]
                });
            }

            if (!charts.cpuHistoryChart) {
                charts.cpuHistoryChart = echarts.init(document.getElementById('cpuHistoryChart'));
                charts.cpuHistoryChart.setOption({
                    tooltip: {
                        trigger: 'axis',
                        formatter: function (params) {
                            params = params[0];
                            const date = new Date(params.value[0]);
                            return date.toLocaleString() + '<br/>'
                                + params.seriesName + ': ' + params.value[1].toFixed(2) + '%';
                        },
                        axisPointer: {
                            animation: false
                        }
                    },
                    xAxis: {
                        type: 'time',
                        splitLine: {
                            show: false
                        }
                    },
                    yAxis: {
                        type: 'value',
                        boundaryGap: [0, '100%'],
                        splitLine: {
                            show: false
                        },
                        max: 100
                    },
                    series: [
                        {
                            name: 'CPU使用率',
                            type: 'line',
                            showSymbol: false,
                            data: []
                        },
                        {
                            name: '危险阈值',
                            type: 'line',
                            markLine: {
                                silent: true,
                                symbol: 'none',
                                label: {
                                    position: 'middle',
                                    formatter: '危险(95%)'
                                },
                                lineStyle: {
                                    color: 'red',
                                    width: 2,
                                    type: 'dashed'
                                },
                                data: [{
                                    yAxis: 95
                                }]
                            }
                        },
                        {
                            name: '警告阈值',
                            type: 'line',
                            markLine: {
                                silent: true,
                                symbol: 'none',
                                label: {
                                    position: 'middle',
                                    formatter: '警告(80%)'
                                },
                                lineStyle: {
                                    color: 'orange',
                                    width: 2,
                                    type: 'dashed'
                                },
                                data: [{
                                    yAxis: 80
                                }]
                            }
                        }
                    ]
                });
            }
        }

        // 初始化内存图表
        function initMemoryCharts() {
            if (!charts.memoryUsageGauge) {
                charts.memoryUsageGauge = echarts.init(document.getElementById('memoryUsageGauge'));
                charts.memoryUsageGauge.setOption({
                    series: [
                        {
                            type: 'gauge',
                            progress: {
                                show: true,
                                width: 18
                            },
                            axisLine: {
                                lineStyle: {
                                    width: 18,
                                    color: [
                                        [0.3, '#67e0e3'],
                                        [0.7, '#37a2da'],
                                        [1, '#fd666d']
                                    ]
                                }
                            },
                            axisTick: {
                                show: false
                            },
                            splitLine: {
                                length: 15,
                                lineStyle: {
                                    width: 2,
                                    color: '#999'
                                }
                            },
                            axisLabel: {
                                distance: 25,
                                color: '#999',
                                fontSize: 10
                            },
                            anchor: {
                                show: true,
                                showAbove: true,
                                size: 25,
                                itemStyle: {
                                    borderWidth: 10
                                }
                            },
                            title: {
                                show: false
                            },
                            detail: {
                                valueAnimation: true,
                                fontSize: 20,
                                formatter: '{value}%'
                            },
                            data: [
                                {
                                    value: 0
                                }
                            ]
                        }
                    ]
                });
            }

            if (!charts.memoryHistoryChart) {
                charts.memoryHistoryChart = echarts.init(document.getElementById('memoryHistoryChart'));
                charts.memoryHistoryChart.setOption({
                    tooltip: {
                        trigger: 'axis',
                        formatter: function (params) {
                            params = params[0];
                            const date = new Date(params.value[0]);
                            return date.toLocaleString() + '<br/>'
                                + params.seriesName + ': ' + params.value[1].toFixed(2) + '%';
                        },
                        axisPointer: {
                            animation: false
                        }
                    },
                    xAxis: {
                        type: 'time',
                        splitLine: {
                            show: false
                        }
                    },
                    yAxis: {
                        type: 'value',
                        boundaryGap: [0, '100%'],
                        splitLine: {
                            show: false
                        },
                        max: 100
                    },
                    series: [
                        {
                            name: '内存使用率',
                            type: 'line',
                            showSymbol: false,
                            data: []
                        },
                        {
                            name: '危险阈值',
                            type: 'line',
                            markLine: {
                                silent: true,
                                symbol: 'none',
                                label: {
                                    position: 'middle',
                                    formatter: '危险(80%)'
                                },
                                lineStyle: {
                                    color: 'red',
                                    width: 2,
                                    type: 'dashed'
                                },
                                data: [{
                                    yAxis: 80
                                }]
                            }
                        },
                        {
                            name: '警告阈值',
                            type: 'line',
                            markLine: {
                                silent: true,
                                symbol: 'none',
                                label: {
                                    position: 'middle',
                                    formatter: '警告(60%)'
                                },
                                lineStyle: {
                                    color: 'orange',
                                    width: 2,
                                    type: 'dashed'
                                },
                                data: [{
                                    yAxis: 60
                                }]
                            }
                        }
                    ]
                });
            }
        }

        // 初始化硬盘图表
        function initDiskCharts() {
            // 磁盘性能图表容器将在loadDiskData中动态创建
        }

        // 初始化驱动图表
        function initDriverCharts() {
            if (!charts.driverTypeChart) {
                charts.driverTypeChart = echarts.init(document.getElementById('driverTypeChart'));
                charts.driverTypeChart.setOption({
                    tooltip: {
                        trigger: 'item'
                    },
                    legend: {
                        top: '5%',
                        left: 'center'
                    },
                    series: [
                        {
                            name: '驱动类型',
                            type: 'pie',
                            radius: ['40%', '70%'],
                            avoidLabelOverlap: false,
                            itemStyle: {
                                borderRadius: 10,
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            label: {
                                show: false,
                                position: 'center'
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: '18',
                                    fontWeight: 'bold'
                                }
                            },
                            labelLine: {
                                show: false
                            },
                            data: [
                                { value: 0, name: '内核驱动' },
                                { value: 0, name: '文件系统' },
                                { value: 0, name: '自启动' },
                                { value: 0, name: '第三方' }
                            ]
                        }
                    ]
                });
            }
        }


        function loadOverviewData() {
            // 获取CPU使用率
            fetch(`${API_BASE}/cpu/usage`)
                .then(response => response.json())
                .then(data => {
                    const usage = data.usage.toFixed(2);
                    document.getElementById('cpuUsageValue').textContent = usage;
                    document.getElementById('cpuUsageBar').style.width = `${usage}%`;
                })
                .catch(err => console.error('加载CPU使用率失败:', err));

            // 获取内存使用率
            fetch(`${API_BASE}/memory/usage`)
                .then(response => response.json())
                .then(data => {
                    const usage = data.usedPercent.toFixed(2);
                    document.getElementById('memoryUsageValue').textContent = usage;
                    document.getElementById('memoryUsageBar').style.width = `${usage}%`;
                })
                .catch(err => console.error('加载内存使用率失败:', err));

            // 获取磁盘使用率 (这里简化处理，实际应计算所有磁盘平均值)
            fetch(`${API_BASE}/disk/info`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.partitions && data.partitions.length > 0) {
                        // 计算所有分区的平均使用率
                        const totalUsage = data.partitions.reduce((sum, partition) => sum + partition.usagePercentage, 0);
                        const avgUsage = (totalUsage / data.partitions.length).toFixed(2);
                        document.getElementById('diskUsageValue').textContent = avgUsage;
                        document.getElementById('diskUsageBar').style.width = `${avgUsage}%`;
                    }
                })
                .catch(err => console.error('加载磁盘信息失败:', err));

            // 获取运行进程数
            fetch(`${API_BASE}/processes`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('processCountValue').textContent = data.totalProcesses;
                })
                .catch(err => console.error('加载进程数失败:', err));

            // 获取系统快照数量
            fetch(`${API_BASE}/system/snapshot/list`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('systemSnapshotCount').textContent = data.length;
                })
                .catch(err => console.error('加载系统快照数量失败:', err));

            // 获取注册表快照数量
            fetch(`${API_BASE}/registry/snapshot/Info`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('registrySnapshotCount').textContent = data.totalBackups;
                })
                .catch(err => console.error('加载注册表快照数量失败:', err));

            // 获取驱动总数
            fetch(`${API_BASE}/drivers/snapshot`)
                .then(response => response.json())
                .then(data => {
                    const stats = data.statistics;
                    document.getElementById('driverCountValue').textContent = stats.totalDrivers;
                })
                .catch(err => console.error('加载驱动总数失败:', err));
        }

        // 加载仪表板数据
        function loadDashboardData() {
            // 加载CPU信息
            fetch(`${API_BASE}/cpu/info`)
                .then(response => response.json())
                .then(data => {
                    // 更新CPU信息显示
                })
                .catch(err => console.error('加载CPU信息失败:', err));

            // 加载CPU使用率
            fetch(`${API_BASE}/cpu/usage`)
                .then(response => response.json())
                .then(data => {
                    charts.cpuGauge.setOption({
                        series: [{
                            data: [{ value: data.usage }]
                        }]
                    });
                })
                .catch(err => console.error('加载CPU使用率失败:', err));

            // 加载内存使用率
            fetch(`${API_BASE}/memory/usage`)
                .then(response => response.json())
                .then(data => {
                    const percent = data.usedPercent;
                    charts.memoryGauge.setOption({
                        series: [{
                            data: [{ value: percent }]
                        }]
                    });

                    // 更新内存详细信息
                    document.getElementById('totalMemory').textContent = formatBytes(data.totalPhysical);
                    document.getElementById('usedMemory').textContent = formatBytes(data.usedPhysical);
                    document.getElementById('availableMemory').textContent = formatBytes(data.availablePhysical);
                })
                .catch(err => console.error('加载内存使用率失败:', err));

            // 加载硬盘信息
            fetch(`${API_BASE}/disk/info`)
                .then(response => response.json())
                .then(data => {
                    const partitions = data.partitions;
                    const driveLetters = partitions.map(p => p.driveLetter);
                    const usagePercentages = partitions.map(p => p.usagePercentage);

                    charts.diskBar.setOption({
                        yAxis: {
                            data: driveLetters
                        },
                        series: [{
                            data: usagePercentages
                        }]
                    });
                })
                .catch(err => console.error('加载硬盘信息失败:', err));

            // 加载进程数据
            loadProcessData();
        }

        // 加载CPU数据
        function loadCpuData() {
            // CPU信息表格
            fetch(`${API_BASE}/cpu/info`)
                .then(response => response.json())
                .then(data => {
                    const cpuInfoTable = document.getElementById('cpuInfoTable');
                    cpuInfoTable.innerHTML = `
                        <tr>
                            <td class="py-2 px-4 border-b font-medium">架构</td>
                            <td class="py-2 px-4 border-b">${data.architecture}</td>
                        </tr>
                        <tr>
                            <td class="py-2 px-4 border-b font-medium">名称</td>
                            <td class="py-2 px-4 border-b">${data.name}</td>
                        </tr>
                        <tr>
                            <td class="py-2 px-4 border-b font-medium">基础频率</td>
                            <td class="py-2 px-4 border-b">${data.baseFrequency} MHz</td>
                        </tr>
                        <tr>
                            <td class="py-2 px-4 border-b font-medium">最大频率</td>
                            <td class="py-2 px-4 border-b">${Math.round(data.maxFrequency / 1000000)} MHz</td>
                        </tr>
                        <tr>
                            <td class="py-2 px-4 border-b font-medium">物理核心数</td>
                            <td class="py-2 px-4 border-b">${data.physicalCores}</td>
                        </tr>
                        <tr>
                            <td class="py-2 px-4 border-b font-medium">逻辑核心数</td>
                            <td class="py-2 px-4 border-b">${data.logicalCores}</td>
                        </tr>
                    `;
                })
                .catch(err => {
                    console.error('加载CPU信息失败:', err);
                    document.getElementById('cpuInfoTable').innerHTML = `
                        <tr>
                            <td colspan="2" class="py-4 text-center text-red-500">
                                加载失败: ${err.message}
                            </td>
                        </tr>
                    `;
                });

            // CPU当前使用率
            fetch(`${API_BASE}/cpu/usage`)
                .then(response => response.json())
                .then(data => {
                    charts.cpuUsageGauge.setOption({
                        series: [{
                            data: [{ value: data.usage.toFixed(2) }]
                        }]
                    });
                })
                .catch(err => console.error('加载CPU使用率失败:', err));

            // CPU历史数据图表
            fetch(`${API_BASE}/cpu/history`)
                .then(response => response.json())
                .then(data => {
                    const chartData = data.map(item => [item.timestamp, item.value]);
                    charts.cpuHistoryChart.setOption({
                        series: [{
                            data: chartData
                        }]
                    });
                })
                .catch(err => console.error('加载CPU历史数据失败:', err));

            // 启动CPU数据自动刷新（如果已启用）
            if (cpuRefreshEnabled) {
                startCpuRefresh();
            }
        }

        // 加载内存数据
        function loadMemoryData() {
            // 内存使用情况
            fetch(`${API_BASE}/memory/usage`)
                .then(response => response.json())
                .then(data => {
                    const percent = data.usedPercent;
                    charts.memoryUsageGauge.setOption({
                        series: [{
                            data: [{ value: percent }]
                        }]
                    });

                    // 更新内存状态显示
                    updateMemoryStatus(percent);

                    // 更新内存详细信息
                    document.getElementById('totalMemory').textContent = formatBytes(data.totalPhysical);
                    document.getElementById('usedMemory').textContent = formatBytes(data.usedPhysical);
                    document.getElementById('availableMemory').textContent = formatBytes(data.availablePhysical);
                })
                .catch(err => console.error('加载内存使用情况失败:', err));

            // 内存历史数据图表
            fetch(`${API_BASE}/memory/history`)
                .then(response => response.json())
                .then(data => {
                    const chartData = data.map(item => [item.timestamp, item.value]);
                    charts.memoryHistoryChart.setOption({
                        series: [{
                            data: chartData
                        }]
                    });
                })
                .catch(err => console.error('加载内存历史数据失败:', err));

            // 启动内存数据自动刷新（如果已启用）
            if (memoryRefreshEnabled) {
                startMemoryRefresh();
            }
        }
        // 添加更新内存状态显示的函数
        function updateMemoryStatus(usage) {
            const statusText = document.getElementById('memoryStatusText');
            const statusDescription = document.getElementById('memoryStatusDescription');

            if (usage > 80) {
                statusText.textContent = '危险';
                statusText.className = 'text-lg font-semibold text-red-600';
                statusDescription.textContent = '内存使用率过高';
                statusDescription.className = 'text-sm text-red-500';
            } else if (usage > 60) {
                statusText.textContent = '警告';
                statusText.className = 'text-lg font-semibold text-orange-500';
                statusDescription.textContent = '内存使用率较高';
                statusDescription.className = 'text-sm text-orange-400';
            } else {
                statusText.textContent = '良好';
                statusText.className = 'text-lg font-semibold text-green-600';
                statusDescription.textContent = '内存使用率正常';
                statusDescription.className = 'text-sm text-gray-500';
            }
        }
        // 加载硬盘数据
        function loadDiskData() {
            // 硬盘列表
            fetch(`${API_BASE}/disk/info`)
                .then(response => response.json())
                .then(data => {
                    const diskTableBody = document.getElementById('diskTableBody');
                    diskTableBody.innerHTML = data.partitions.map(partition => `
                <tr>
                    <td class="py-2 px-4 border-b">${partition.driveLetter}</td>
                    <td class="py-2 px-4 border-b">${partition.label}</td>
                    <td class="py-2 px-4 border-b">${formatBytes(partition.totalSize)}</td>
                    <td class="py-2 px-4 border-b">${formatBytes(partition.usedSpace)}</td>
                    <td class="py-2 px-4 border-b">${formatBytes(partition.freeSpace)}</td>
                    <td class="py-2 px-4 border-b">${partition.usagePercentage.toFixed(2)}%</td>
                </tr>
            `).join('');

                    // 创建磁盘使用情况饼图
                    createDiskUsageCharts(data.partitions);
                })
                .catch(err => {
                    console.error('加载硬盘列表失败:', err);
                    document.getElementById('diskTableBody').innerHTML = `
                <tr>
                    <td colspan="6" class="py-4 text-center text-red-500">
                        加载失败: ${err.message}
                    </td>
                </tr>
            `;
                });

            // 硬盘性能图表
            fetch(`${API_BASE}/disk/performance`)
                .then(response => response.json())
                .then(data => {
                    const performance = data.performance;

                    // 创建每个磁盘的读写速度折线图
                    createDiskPerformanceCharts(performance);
                })
                .catch(err => console.error('加载硬盘性能失败:', err));

            // 启动硬盘数据自动刷新（如果已启用）
            if (diskRefreshEnabled) {
                startDiskRefresh();
            }
        }
        // 创建磁盘使用情况饼图
        function createDiskUsageCharts(partitions) {
            const container = document.getElementById('diskUsageCharts');
            container.innerHTML = ''; // 清空现有内容

            partitions.forEach(partition => {
                // 创建图表容器
                const chartContainer = document.createElement('div');
                chartContainer.className = 'p-4';
                chartContainer.innerHTML = `
            <h4 class="font-medium text-center mb-2">${partition.driveLetter} 使用情况</h4>
            <div id="diskUsageChart-${partition.driveLetter}" class="h-48"></div>
        `;
                container.appendChild(chartContainer);

                // 初始化图表
                const chartDom = document.getElementById(`diskUsageChart-${partition.driveLetter}`);
                const chart = echarts.init(chartDom);

                // 根据使用率确定颜色和状态
                let color, status;
                if (partition.usagePercentage > 90) {
                    color = '#ef4444'; // 红色 - 危险
                    status = '危险';
                } else if (partition.usagePercentage > 70) {
                    color = '#f97316'; // 橙色 - 警告
                    status = '警告';
                } else {
                    color = '#22c55e'; // 绿色 - 良好
                    status = '良好';
                }

                chart.setOption({
                    tooltip: {
                        trigger: 'item',
                        formatter: `{a} <br/>{b}: {c}GB ({d}%)`
                    },
                    series: [
                        {
                            name: `${partition.driveLetter} 使用情况`,
                            type: 'pie',
                            radius: ['40%', '70%'],
                            avoidLabelOverlap: false,
                            itemStyle: {
                                borderRadius: 10,
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            label: {
                                show: true,
                                position: 'center',
                                formatter: `${status}\n${partition.usagePercentage.toFixed(1)}%`,
                                fontSize: 14,
                                fontWeight: 'bold'
                            },
                            labelLine: {
                                show: false
                            },
                            data: [
                                {
                                    value: (partition.usedSpace / (1024 ** 3)).toFixed(2), // 转换为GB
                                    name: '已使用',
                                    itemStyle: { color: color }
                                },
                                {
                                    value: (partition.freeSpace / (1024 ** 3)).toFixed(2), // 转换为GB
                                    name: '可用空间',
                                    itemStyle: { color: '#cbd5e1' }
                                }
                            ]
                        }
                    ]
                });

                // 保存图表实例
                diskCharts[`usage-${partition.driveLetter}`] = chart;
            });
        }


        // 创建磁盘性能折线图
        function createDiskPerformanceCharts(performanceData) {
            const container = document.getElementById('diskPerformanceCharts');
            container.innerHTML = ''; // 清空现有内容

            performanceData.forEach(disk => {
                // 创建图表容器
                const chartContainer = document.createElement('div');
                chartContainer.className = 'p-4 border rounded mb-4';
                chartContainer.innerHTML = `
            <h4 class="font-medium mb-2">${disk.driveLetter} 读写速度</h4>
            <div id="diskPerformanceChart-${disk.driveLetter}" class="h-64"></div>
        `;
                container.appendChild(chartContainer);

                // 初始化图表
                const chartDom = document.getElementById(`diskPerformanceChart-${disk.driveLetter}`);
                const chart = echarts.init(chartDom);

                chart.setOption({
                    tooltip: {
                        trigger: 'axis'
                    },
                    legend: {
                        data: ['读取速度 (KB/s)', '写入速度 (KB/s)']
                    },
                    xAxis: {
                        type: 'category',
                        data: [] // 时间轴数据将在更新时填充
                    },
                    yAxis: {
                        type: 'value',
                        name: 'KB/s'
                    },
                    series: [
                        {
                            name: '读取速度 (KB/s)',
                            type: 'line',
                            data: [],
                            smooth: true
                        },
                        {
                            name: '写入速度 (KB/s)',
                            type: 'line',
                            data: [],
                            smooth: true
                        }
                    ]
                });

                // 保存图表实例
                diskCharts[`performance-${disk.driveLetter}`] = chart;
            });

            // 更新图表数据
            updateDiskPerformanceChartData(performanceData);
        }

        // 更新磁盘性能图表数据
        function updateDiskPerformanceChartData(performanceData) {
            performanceData.forEach(disk => {
                const chart = diskCharts[`performance-${disk.driveLetter}`];
                if (chart) {
                    // 获取当前图表选项
                    const option = chart.getOption();

                    // 初始化数据数组（如果为空）
                    if (!option.xAxis[0].data.length) {
                        option.xAxis[0].data = Array(20).fill(0).map((_, i) => {
                            const time = new Date(Date.now() - (19 - i) * 2000);
                            return `${time.getHours()}:${time.getMinutes().toString().padStart(2, '0')}:${time.getSeconds().toString().padStart(2, '0')}`;
                        });

                        option.series[0].data = Array(20).fill(0);
                        option.series[1].data = Array(20).fill(0);
                    }

                    // 更新数据（移除第一个元素，添加新数据）
                    option.xAxis[0].data.shift();
                    const now = new Date();
                    option.xAxis[0].data.push(`${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`);

                    option.series[0].data.shift();
                    option.series[0].data.push(Math.round(disk.readBytesPerSec / 1024));

                    option.series[1].data.shift();
                    option.series[1].data.push(Math.round(disk.writeBytesPerSec / 1024));

                    // 应用更新
                    chart.setOption(option);
                }
            });
        }

        // 硬盘刷新控制函数
        function toggleDiskRefresh() {
            diskRefreshEnabled = !diskRefreshEnabled;
            const toggleBtn = document.getElementById('diskRefreshToggle');

            if (diskRefreshEnabled) {
                toggleBtn.textContent = '暂停刷新';
                toggleBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm';
                startDiskRefresh();
            } else {
                toggleBtn.textContent = '开始刷新';
                toggleBtn.className = 'bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm';
                stopDiskRefresh();
            }
        }

        function changeDiskRefreshInterval() {
            diskRefreshInterval = parseInt(document.getElementById('diskRefreshInterval').value);
            if (diskRefreshEnabled) {
                stopDiskRefresh();
                startDiskRefresh();
            }
        }

        function startDiskRefresh() {
            stopDiskRefresh(); // 先清除已有的定时器
            diskRefreshTimer = setInterval(() => {
                updateDiskUsageData();
            }, diskRefreshInterval);
        }

        function stopDiskRefresh() {
            if (diskRefreshTimer) {
                clearInterval(diskRefreshTimer);
                diskRefreshTimer = null;
            }
        }

        // 更新硬盘使用率数据
        function updateDiskUsageData() {
            // 更新磁盘使用情况饼图
            fetch(`${API_BASE}/disk/info`)
                .then(response => response.json())
                .then(data => {
                    // 更新饼图
                    data.partitions.forEach(partition => {
                        const chart = diskCharts[`usage-${partition.driveLetter}`];
                        if (chart) {
                            // 根据使用率确定颜色和状态
                            let color, status;
                            if (partition.usagePercentage > 90) {
                                color = '#ef4444'; // 红色 - 危险
                                status = '危险';
                            } else if (partition.usagePercentage > 70) {
                                color = '#f97316'; // 橙色 - 警告
                                status = '警告';
                            } else {
                                color = '#22c55e'; // 绿色 - 良好
                                status = '良好';
                            }

                            chart.setOption({
                                series: [{
                                    data: [
                                        {
                                            value: (partition.usedSpace / (1024 ** 3)).toFixed(2),
                                            name: '已使用',
                                            itemStyle: { color: color }
                                        },
                                        {
                                            value: (partition.freeSpace / (1024 ** 3)).toFixed(2),
                                            name: '可用空间',
                                            itemStyle: { color: '#cbd5e1' }
                                        }
                                    ]
                                }],
                                series: [{
                                    label: {
                                        show: true,
                                        position: 'center',
                                        formatter: `${status}\n${partition.usagePercentage.toFixed(1)}%`,
                                        fontSize: 14,
                                        fontWeight: 'bold'
                                    }
                                }]
                            });
                        }
                    });
                })
                .catch(err => console.error('更新磁盘使用情况失败:', err));

            // 更新磁盘性能折线图
            fetch(`${API_BASE}/disk/performance`)
                .then(response => response.json())
                .then(data => {
                    updateDiskPerformanceChartData(data.performance);
                })
                .catch(err => console.error('更新磁盘性能失败:', err));
        }

        // 在窗口大小改变时重绘图表部分添加磁盘图表处理
        window.addEventListener('resize', function () {
            for (let chartName in charts) {
                if (charts[chartName]) {
                    charts[chartName].resize();
                }
            }
            // 处理磁盘图表
            for (let chartName in diskCharts) {
                if (diskCharts[chartName]) {
                    diskCharts[chartName].resize();
                }
            }
        });

        // 绑定进程相关事件
        function bindProcessEvents() {
            // 进程搜索事件
            document.getElementById('processSearch').addEventListener('input', function () {
                loadProcessData(this.value);
            });

            // 进程排序事件
            document.querySelectorAll('.sortable').forEach(th => {
                th.addEventListener('click', function () {
                    const field = this.getAttribute('data-sort');
                    sortProcesses(field);
                });
            });

            // 进程刷新控制事件
            document.getElementById('processRefreshToggle').addEventListener('click', toggleProcessRefresh);
            document.getElementById('processRefreshInterval').addEventListener('change', changeProcessRefreshInterval);
            document.getElementById('processDisplayCount').addEventListener('change', changeProcessDisplayCount);

            // 进程详情模态窗口事件
            document.getElementById('closeProcessDetailModal').addEventListener('click', closeProcessDetailModal);
        }


        // 进程刷新控制函数
        function toggleProcessRefresh() {
            processRefreshEnabled = !processRefreshEnabled;
            const toggleBtn = document.getElementById('processRefreshToggle');

            if (processRefreshEnabled) {
                toggleBtn.textContent = '暂停刷新';
                toggleBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm';
                startProcessRefresh();
            } else {
                toggleBtn.textContent = '开始刷新';
                toggleBtn.className = 'bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm';
                stopProcessRefresh();
            }
        }

        function changeProcessRefreshInterval() {
            processRefreshInterval = parseInt(document.getElementById('processRefreshInterval').value);
            if (processRefreshEnabled) {
                stopProcessRefresh();
                startProcessRefresh();
            }
        }

        function changeProcessDisplayCount() {
            const value = document.getElementById('processDisplayCount').value;
            processDisplayCount = value === 'all' ? Infinity : parseInt(value);
            loadProcessData(document.getElementById('processSearch').value);
        }

        function startProcessRefresh() {
            stopProcessRefresh(); // 先清除已有的定时器
            processRefreshTimer = setInterval(() => {
                loadProcessData(document.getElementById('processSearch').value);
            }, processRefreshInterval);
        }

        function stopProcessRefresh() {
            if (processRefreshTimer) {
                clearInterval(processRefreshTimer);
                processRefreshTimer = null;
            }
        }


        // 加载进程数据
        // 加载进程数据
        function loadProcessData(search = '') {
            fetch(`${API_BASE}/processes`)
                .then(response => response.json())
                .then(data => {
                    // 更新进程统计信息
                    document.getElementById('totalProcessCount').textContent = data.totalProcesses;
                    document.getElementById('totalThreadCount').textContent = data.totalThreads;

                    // 新增统计信息
                    let totalHandleCount = 0;
                    let totalGdiCount = 0;
                    let totalUserCount = 0;

                    data.processes.forEach(process => {
                        totalHandleCount += process.handleCount || 0;
                        totalGdiCount += process.gdiCount || 0;
                        totalUserCount += process.userCount || 0;
                    });

                    document.getElementById('totalHandleCount').textContent = totalHandleCount;
                    document.getElementById('totalGdiCount').textContent = totalGdiCount;
                    document.getElementById('totalUserCount').textContent = totalUserCount;


                    let processes = data.processes;

                    // 应用搜索过滤
                    if (search) {
                        processes = processes.filter(p =>
                            p.name.toLowerCase().includes(search.toLowerCase())
                        );
                    }

                    // 应用排序
                    processes.sort((a, b) => {
                        let aVal, bVal;

                        switch (processSort.field) {
                            case 'name':
                                aVal = a.name.toLowerCase();
                                bVal = b.name.toLowerCase();
                                break;
                            case 'pid':
                                aVal = a.pid;
                                bVal = b.pid;
                                break;
                            case 'cpu':
                                aVal = a.cpuUsage;
                                bVal = b.cpuUsage;
                                break;
                            case 'memory':
                                aVal = a.memoryUsage;
                                bVal = b.memoryUsage;
                                break;
                            default:
                                return 0;
                        }

                        if (processSort.direction === 'asc') {
                            return aVal > bVal ? 1 : -1;
                        } else {
                            return aVal < bVal ? 1 : -1;
                        }
                    });

                    // 应用显示数量限制
                    if (processDisplayCount !== Infinity) {
                        processes = processes.slice(0, processDisplayCount);
                    }

                    const processListTableBody = document.getElementById('processListTableBody');
                    processListTableBody.innerHTML = processes.map(process => `
    <tr>
        <td class="py-2 px-4 border-b">${process.name}</td>
        <td class="py-2 px-4 border-b">${process.pid}</td>
        <td class="py-2 px-4 border-b">${process.cpuUsage.toFixed(2)}%</td>
        <td class="py-2 px-4 border-b">${formatBytes(process.memoryUsage)}</td>
        <td class="py-2 px-4 border-b">${process.threadCount}</td>
        <td class="py-2 px-4 border-b">${process.handleCount || 0}</td>
        <td class="py-2 px-4 border-b">${process.gdiCount || 0}</td>
        <td class="py-2 px-4 border-b">${process.userCount || 0}</td>
        <td class="py-2 px-4 border-b">${process.state}</td>
        <td class="py-2 px-4 border-b">
            <button onclick="showProcessDetail(${process.pid})" 
                    class="text-blue-500 hover:text-blue-700 mr-2">详情</button>
        </td>
    </tr>
            `).join('');

                    // 绑定详情按钮事件
                    document.querySelectorAll('.process-detail').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const pid = this.getAttribute('data-pid');
                            showProcessDetail(pid);
                        });
                    });
                })
                .catch(err => {
                    console.error('加载进程数据失败:', err);
                });
        }


        // 显示进程详情
        function showProcessDetail(pid) {
            fetch(`${API_BASE}/process/${pid}`)
                .then(response => response.json())
                .then(data => {
                    const detailContent = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-semibold text-gray-700">基本信息</h4>
                        <div class="ml-2">
                            <p><span class="font-medium">进程名:</span> ${data.name}</p>
                            <p><span class="font-medium">PID:</span> ${data.pid}</p>
                            <p><span class="font-medium">父进程PID:</span> ${data.parentPid}</p>
                            <p><span class="font-medium">状态:</span> ${data.state}</p>
                            <p><span class="font-medium">优先级:</span> ${data.priority}</p>
                            <p><span class="font-medium">线程数:</span> ${data.threadCount}</p>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700">资源使用</h4>
                        <div class="ml-2">
                            <p><span class="font-medium">CPU使用率:</span> ${data.cpuUsage.toFixed(2)}%</p>
                            <p><span class="font-medium">内存使用:</span> ${formatBytes(data.memoryUsage)}</p>
                            <p><span class="font-medium">工作集大小:</span> ${formatBytes(data.workingSetSize)}</p>
                            <p><span class="font-medium">页面文件使用:</span> ${formatBytes(data.pagefileUsage)}</p>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <h4 class="font-semibold text-gray-700">其他信息</h4>
                        <div class="ml-2">
                            <p><span class="font-medium">命令行:</span> ${data.commandLine || 'N/A'}</p>
                            <p><span class="font-medium">完整路径:</span> ${data.fullPath || 'N/A'}</p>
                            <p><span class="font-medium">用户名:</span> ${data.username || 'N/A'}</p>
                            <p><span class="font-medium">创建时间:</span> ${new Date(data.createTime / 10000 - 11644473600000).toLocaleString()}</p>
                        </div>
                    </div>
                </div>
            `;
                    document.getElementById('processDetailContent').innerHTML = detailContent;
                    document.getElementById('processDetailModal').classList.remove('hidden');
                })
                .catch(err => {
                    console.error('获取进程详情失败:', err);
                    alert('获取进程详情失败');
                });
        }
        // 关闭进程详情模态窗口
        function closeProcessDetailModal() {
            document.getElementById('processDetailModal').classList.add('hidden');
        }


        // 终止进程
        function terminateProcess(pid) {
            fetch(`${API_BASE}/process/${pid}/terminate`, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`进程 PID: ${pid} 已终止`);
                        loadProcessData();
                    } else {
                        alert(`终止进程失败: ${data.error}`);
                    }
                })
                .catch(err => {
                    console.error('终止进程失败:', err);
                    alert(`终止进程失败: ${err.message}`);
                });
        }

        // 进程排序
        function sortProcesses(field) {
            if (processSort.field === field) {
                processSort.direction = processSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                processSort.field = field;
                processSort.direction = 'asc';
            }
            loadProcessData(document.getElementById('processSearch').value);
        }

        // 加载驱动数据
        function loadDriverData() {
            fetch(`${API_BASE}/drivers/snapshot`)
                .then(response => response.json())
                .then(data => {
                    // 更新驱动统计
                    const stats = data.statistics;
                    document.getElementById('totalDrivers').textContent = stats.totalDrivers;
                    document.getElementById('runningDrivers').textContent = stats.runningCount;
                    document.getElementById('stoppedDrivers').textContent = stats.stoppedCount;
                    document.getElementById('kernelDrivers').textContent = stats.kernelCount;
                    document.getElementById('fileSystemDrivers').textContent = stats.fileSystemCount;
                    document.getElementById('autoStartDrivers').textContent = stats.autoStartCount;
                    document.getElementById('thirdPartyDrivers').textContent = stats.thirdPartyCount;

                    // 更新驱动类型分布图表
                    charts.driverTypeChart.setOption({
                        series: [{
                            data: [
                                { value: stats.kernelCount, name: '内核驱动' },
                                { value: stats.fileSystemCount, name: '文件系统' },
                                { value: stats.autoStartCount, name: '自启动' },
                                { value: stats.thirdPartyCount, name: '第三方' }
                            ]
                        }]
                    });

                    // 合并并过滤驱动列表
                    let allDrivers = [
                        ...data.runningDrivers.map(d => ({ ...d, state: '运行中' })),
                        ...data.stoppedDrivers.map(d => ({ ...d, state: '已停止' }))
                    ];

                    // 应用过滤器
                    allDrivers = filterDrivers(allDrivers, driverFilter);

                    // 应用排序
                    allDrivers = sortDrivers(allDrivers, driverSort.field, driverSort.direction);

                    // 应用显示数量限制
                    if (driverDisplayCount !== Infinity) {
                        allDrivers = allDrivers.slice(0, driverDisplayCount);
                    }

                    // 更新驱动列表
                    const driverTableBody = document.getElementById('driverTableBody');
                    if (allDrivers.length === 0) {
                        driverTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="py-4 text-center text-gray-500">
                            没有找到匹配的驱动
                        </td>
                    </tr>
                `;
                    } else {
                        driverTableBody.innerHTML = allDrivers.map(driver => `
                    <tr>
                        <td class="py-2 px-4 border-b truncate" title="${driver.name}">${driver.name}</td>
                        <td class="py-2 px-4 border-b truncate" title="${driver.displayName}">${driver.displayName}</td>
                        <td class="py-2 px-4 border-b">${driver.state}</td>
                        <td class="py-2 px-4 border-b">${driver.startType}</td>
                        <td class="py-2 px-4 border-b">${driver.driverType || 'N/A'}</td>
                        <td class="py-2 px-4 border-b truncate" title="${driver.binaryPath}">${driver.binaryPath}</td>
                    </tr>
                `).join('');
                    }
                })
                .catch(err => {
                    console.error('加载驱动数据失败:', err);
                    document.getElementById('driverTableBody').innerHTML = `
                <tr>
                    <td colspan="6" class="py-4 text-center text-red-500">
                        加载失败: ${err.message}
                    </td>
                </tr>
            `;
                });
        }
        // 驱动过滤函数
        function filterDrivers(drivers, filter) {
            switch (filter) {
                case 'running':
                    return drivers.filter(d => d.state === '运行中');
                case 'stopped':
                    return drivers.filter(d => d.state === '已停止');
                // case 'kernel':
                //     return drivers.filter(d => d.driverType === 'Kernel');
                // case 'filesystem':
                //     return drivers.filter(d => d.driverType === 'File System');
                // case 'autostart':
                //     return drivers.filter(d => d.startType === 'Auto Start');
                // case 'thirdparty':
                //     return drivers.filter(d => d.isThirdParty);
                default:
                    return drivers;
            }
        }

        // 驱动排序函数
        function sortDrivers(drivers, field, direction) {
            return drivers.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];

                // 处理特殊字段
                if (field === 'isThirdParty') {
                    aVal = aVal ? '是' : '否';
                    bVal = bVal ? '是' : '否';
                }

                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (aVal < bVal) {
                    return direction === 'asc' ? -1 : 1;
                }
                if (aVal > bVal) {
                    return direction === 'asc' ? 1 : -1;
                }
                return 0;
            });
        }

        // 驱动排序处理
        function sortDriversBy(field) {
            if (driverSort.field === field) {
                driverSort.direction = driverSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                driverSort.field = field;
                driverSort.direction = 'asc';
            }

            // 更新表头指示器
            document.querySelectorAll('.sortable-driver').forEach(th => {
                const sortField = th.getAttribute('data-sort');
                if (sortField === field) {
                    th.innerHTML = th.innerHTML.replace(/▲|▼/, '') + (driverSort.direction === 'asc' ? ' ▲' : ' ▼');
                } else {
                    th.innerHTML = th.innerHTML.replace(/▲|▼/, '');
                }
            });

            loadDriverData();
        }
        // 加载快照数据
        function loadSnapshotData() {
            fetch(`${API_BASE}/registry/snapshots`)
                .then(response => response.json())
                .then(data => {
                    // 更新快照列表
                    const snapshotTableBody = document.getElementById('snapshotTableBody');
                    snapshotTableBody.innerHTML = data.map(snapshot => `
                        <tr>
                            <td class="py-2 px-4 border-b">${snapshot.name}</td>
                            <td class="py-2 px-4 border-b">${new Date(snapshot.timestamp).toLocaleString()}</td>
                            <td class="py-2 px-4 border-b">${snapshot.systemInfoCount}</td>
                            <td class="py-2 px-4 border-b">${snapshot.softwareCount}</td>
                            <td class="py-2 px-4 border-b">${snapshot.networkCount}</td>
                            <td class="py-2 px-4 border-b">
                                <button class="text-red-500 hover:text-red-700 delete-snapshot" data-name="${snapshot.name}">删除</button>
                            </td>
                        </tr>
                    `).join('');

                    // 绑定删除事件
                    document.querySelectorAll('.delete-snapshot').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const name = this.getAttribute('data-name');
                            deleteSnapshot(name);
                        });
                    });

                    // 更新快照选择下拉框
                    const snapshot1Select = document.getElementById('snapshot1Select');
                    const snapshot2Select = document.getElementById('snapshot2Select');

                    let options = '<option value="">请选择快照</option>';
                    data.forEach(snapshot => {
                        options += `<option value="${snapshot.name}">${snapshot.name}</option>`;
                    });

                    snapshot1Select.innerHTML = options;
                    snapshot2Select.innerHTML = options;
                })
                .catch(err => {
                    console.error('加载快照数据失败:', err);
                    document.getElementById('snapshotTableBody').innerHTML = `
                        <tr>
                            <td colspan="6" class="py-4 text-center text-red-500">
                                加载失败: ${err.message}
                            </td>
                        </tr>
                    `;
                });
        }

        // 创建快照
        function createSnapshot() {
            const snapshotName = prompt('请输入快照名称:');
            if (!snapshotName) return;

            fetch(`${API_BASE}/registry/snapshot/save`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ snapshotName })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('快照创建成功');
                        loadSnapshotData();
                    } else {
                        alert(`快照创建失败: ${data.error}`);
                    }
                })
                .catch(err => {
                    console.error('创建快照失败:', err);
                    alert(`创建快照失败: ${err.message}`);
                });
        }

        // 删除快照
        function deleteSnapshot(name) {
            if (!confirm(`确定要删除快照 "${name}" 吗？`)) return;

            fetch(`${API_BASE}/registry/snapshots/delete/${name}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('快照删除成功');
                        loadSnapshotData();
                    } else {
                        alert(`快照删除失败: ${data.error}`);
                    }
                })
                .catch(err => {
                    console.error('删除快照失败:', err);
                    alert(`删除快照失败: ${err.message}`);
                });
        }

        // 对比快照
        function compareSnapshots() {
            const snapshot1 = document.getElementById('snapshot1Select').value;
            const snapshot2 = document.getElementById('snapshot2Select').value;

            if (!snapshot1 || !snapshot2) {
                alert('请选择两个快照进行对比');
                return;
            }

            if (snapshot1 === snapshot2) {
                alert('请选择不同的快照进行对比');
                return;
            }

            fetch(`${API_BASE}/registry/snapshots/compare`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    snapshot1,
                    snapshot2
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`对比失败: ${data.error}`);
                        return;
                    }

                    // 显示对比结果
                    document.getElementById('comparisonResult').style.display = 'block';

                    // 显示新增项
                    const addedItems = document.getElementById('addedItems');
                    if (data.systemInfoChanges && data.systemInfoChanges.added) {
                        addedItems.innerHTML = data.systemInfoChanges.added
                            .map(item => `<li>${item}</li>`)
                            .join('');
                    } else {
                        addedItems.innerHTML = '<li>无新增项</li>';
                    }

                    // 显示修改项
                    const modifiedItems = document.getElementById('modifiedItems');
                    if (data.systemInfoChanges && data.systemInfoChanges.modified) {
                        modifiedItems.innerHTML = data.systemInfoChanges.modified
                            .map(item => `<li>${item}</li>`)
                            .join('');
                    } else {
                        modifiedItems.innerHTML = '<li>无修改项</li>';
                    }

                    // 显示删除项
                    const removedItems = document.getElementById('removedItems');
                    if (data.systemInfoChanges && data.systemInfoChanges.removed) {
                        removedItems.innerHTML = data.systemInfoChanges.removed
                            .map(item => `<li>${item}</li>`)
                            .join('');
                    } else {
                        removedItems.innerHTML = '<li>无删除项</li>';
                    }
                })
                .catch(err => {
                    console.error('快照对比失败:', err);
                    alert(`快照对比失败: ${err.message}`);
                });
        }

        // 加载注册表数据
        function loadRegistryData() {
            fetch(`${API_BASE}/registry/snapshot/Info`)
                .then(response => response.json())
                .then(data => {
                    // 更新注册表表格
                    const registryTableBody = document.getElementById('registryTableBody');

                    if (data.backups && data.backups.length > 0) {
                        registryTableBody.innerHTML = data.backups.map(backup => `
                    <tr>
                        <td class="py-2 px-4 border-b">${backup.folderName}</td>
                        <td class="py-2 px-4 border-b">${new Date(backup.createTime * 1000).toLocaleString()}</td>
                        <td class="py-2 px-4 border-b">${formatBytes(backup.totalSize)}</td>
                        <td class="py-2 px-4 border-b">${backup.fileCount}</td>
                        <td class="py-2 px-4 border-b">
                            <button class="text-red-500 hover:text-red-700 delete-registry-snapshot" 
                                    data-folder="${backup.folderName}">
                                删除
                            </button>
                        </td>
                    </tr>
                `).join('');

                        // 绑定删除事件
                        document.querySelectorAll('.delete-registry-snapshot').forEach(btn => {
                            btn.addEventListener('click', function () {
                                const folderName = this.getAttribute('data-folder');
                                deleteRegistrySnapshot(folderName);
                            });
                        });

                        // 更新对比下拉框
                        updateRegistryComparisonDropdowns(data.backups);
                    } else {
                        registryTableBody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">暂无数据</td></tr>';
                    }
                })
                .catch(err => {
                    console.error('加载注册表数据失败:', err);
                    document.getElementById('registryTableBody').innerHTML =
                        '<tr><td colspan="5" class="py-4 text-center text-red-500">加载失败</td></tr>';
                });
        }

        // 保存注册表快照
        function saveRegistrySnapshot() {
            const statusDiv = document.getElementById('registryStatus');
            const statusText = document.getElementById('statusText');
            const statusIcon = document.getElementById('statusIcon');
            const backupDir = document.getElementById('backupDir');

            // 显示加载状态
            statusDiv.className = 'p-4 rounded-lg mb-4 bg-blue-100 border border-blue-300';
            statusIcon.innerHTML = 'ℹ️';
            statusText.textContent = '正在保存注册表快照...';
            backupDir.textContent = '';
            statusDiv.classList.remove('hidden');

            fetch(`${API_BASE}/registry/snapshot/save`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' || data.status === 'partial_failure') {
                        statusDiv.className = 'p-4 rounded-lg mb-4 bg-green-100 border border-green-300';
                        statusIcon.innerHTML = '✅';
                        statusText.textContent = data.message;
                        if (data.backupDir) {
                            const dirParts = data.backupDir.split('\\');
                            backupDir.textContent = `(${dirParts[dirParts.length - 1]})`;
                        }
                    } else {
                        statusDiv.className = 'p-4 rounded-lg mb-4 bg-red-100 border border-red-300';
                        statusIcon.innerHTML = '❌';
                        statusText.textContent = data.message || '保存失败';
                        backupDir.textContent = '';
                    }
                    loadRegistryData(); // 刷新列表
                })
                .catch(err => {
                    statusDiv.className = 'p-4 rounded-lg mb-4 bg-red-100 border border-red-300';
                    statusIcon.innerHTML = '❌';
                    statusText.textContent = '请求失败: ' + err.message;
                    backupDir.textContent = '';
                });
        }

        // 删除注册表快照
        function deleteRegistrySnapshot(folderName) {
            if (!confirm(`确定要删除注册表快照 "${folderName}" 吗？`)) return;

            fetch(`${API_BASE}/registry/snapshot/delete/${folderName}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('删除成功');
                        loadRegistryData();
                    } else {
                        alert(`删除失败: ${data.error}`);
                    }
                })
                .catch(err => {
                    console.error('删除注册表快照失败:', err);
                    alert(`删除失败: ${err.message}`);
                });
        }

        // 更新注册表对比下拉框
        function updateRegistryComparisonDropdowns(backups) {
            const select1 = document.getElementById('registrySnapshot1');
            const select2 = document.getElementById('registrySnapshot2');

            let options = '<option value="">请选择快照</option>';
            backups.forEach(backup => {
                options += `<option value="${backup.folderName}">${backup.folderName}</option>`;
            });

            select1.innerHTML = options;
            select2.innerHTML = options;
        }

        // 对比注册表快照
        // 修改 compareRegistrySnapshots 函数，添加加载状态提示
        function compareRegistrySnapshots() {
            const folder1 = document.getElementById('registrySnapshot1').value;
            const folder2 = document.getElementById('registrySnapshot2').value;

            if (!folder1 || !folder2) {
                alert('请选择两个快照进行对比');
                return;
            }

            if (folder1 === folder2) {
                alert('请选择不同的快照进行对比');
                return;
            }

            // 显示加载状态
            let compareBtn = document.getElementById('compareRegistryBtn');
            const originalBtnText = compareBtn.innerHTML;
            compareBtn.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-4 w-4 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>对比中...';
            compareBtn.disabled = true;

            // 显示对比结果区域并添加加载提示
            const comparisonResult = document.getElementById('registryComparisonResult');
            comparisonResult.classList.remove('hidden');
            comparisonResult.innerHTML = `
        <div class="flex justify-center items-center p-8">
            <div class="text-center">
                <svg class="animate-spin h-12 w-12 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-gray-600">正在对比注册表快照，请稍候...</p>
                <p class="text-sm text-gray-500 mt-2">这可能需要一些时间</p>
            </div>
        </div>
    `;

            fetch(`${API_BASE}/registry/snapshot/compare`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    folder1: folder1,
                    folder2: folder2
                })
            })
                .then(response => response.json())
                .then(data => {
                    // 恢复按钮状态
                    compareBtn.innerHTML = originalBtnText;
                    compareBtn.disabled = false;

                    if (data.error) {
                        // 显示错误信息
                        comparisonResult.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                    <div class="flex items-center">
                        <svg class="h-5 w-5 text-red-400 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                        <h4 class="text-lg font-medium text-red-800">对比失败</h4>
                    </div>
                    <p class="mt-2 text-red-700">${data.error}</p>
                    <button onclick="this.parentElement.parentElement.classList.add('hidden')" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">关闭</button>
                </div>
            `;
                        return;
                    }

                    // 显示对比结果
                    displayRegistryComparisonResult(data);
                })
                .catch(err => {
                    // 恢复按钮状态
                    compareBtn.innerHTML = originalBtnText;
                    compareBtn.disabled = false;

                    // 显示错误信息
                    comparisonResult.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-red-400 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                    <h4 class="text-lg font-medium text-red-800">请求失败</h4>
                </div>
                <p class="mt-2 text-red-700">对比注册表快照时发生错误: ${err.message}</p>
                <button onclick="this.parentElement.parentElement.classList.add('hidden')" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">关闭</button>
            </div>
        `;
                });
        }


        // 添加显示对比结果的函数
        function displayRegistryComparisonResult(data) {
            const comparisonResult = document.getElementById('registryComparisonResult');

            // 计算独有文件数
            const uniqueFiles = (data.filesOnlyInFolder1?.length || 0) + (data.filesOnlyInFolder2?.length || 0);

            comparisonResult.innerHTML = `
        <h4 class="font-medium mb-4">对比结果</h4>
        
        <!-- 总览统计 -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
            <div class="p-4 bg-blue-50 rounded-lg text-center">
                <p class="text-2xl font-bold text-blue-700" id="totalComparedFiles">${data.totalComparedFiles || 0}</p>
                <p class="text-sm text-gray-600">对比文件数</p>
            </div>
            <div class="p-4 bg-green-50 rounded-lg text-center">
                <p class="text-2xl font-bold text-green-700" id="totalAddedKeys">${data.totalAddedKeys || 0}</p>
                <p class="text-sm text-gray-600">新增键数</p>
            </div>
            <div class="p-4 bg-red-50 rounded-lg text-center">
                <p class="text-2xl font-bold text-red-700" id="totalRemovedKeys">${data.totalRemovedKeys || 0}</p>
                <p class="text-sm text-gray-600">删除键数</p>
            </div>
            <div class="p-4 bg-yellow-50 rounded-lg text-center">
                <p class="text-2xl font-bold text-yellow-700" id="totalModifiedKeys">${data.totalModifiedKeys || 0}</p>
                <p class="text-sm text-gray-600">修改键数</p>
            </div>
            <div class="p-4 bg-purple-50 rounded-lg text-center">
                <p class="text-2xl font-bold text-purple-700" id="uniqueFiles">${uniqueFiles}</p>
                <p class="text-sm text-gray-600">独有文件</p>
            </div>
        </div>
        
        <!-- 文件对比详情 -->
        <div class="mb-6">
            <h5 class="font-medium mb-2">文件对比详情</h5>
            <div class="overflow-x-auto">
                <table class="min-w-full process-table">
                    <thead>
                        <tr>
                            <th class="py-2 px-4 text-left sortable" data-sort="prefix">前缀</th>
                            <th class="py-2 px-4 text-left">文件1</th>
                            <th class="py-2 px-4 text-left">文件2</th>
                            <th class="py-2 px-4 text-left">新增键</th>
                            <th class="py-2 px-4 text-left">删除键</th>
                            <th class="py-2 px-4 text-left">修改键</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonFilesTable">
                        ${data.comparedFiles && data.comparedFiles.length > 0 ?
                    data.comparedFiles.map(file => `
                            <tr>
                                <td class="py-2 px-4 border-b">${file.prefix}</td>
                                <td class="py-2 px-4 border-b">${file.file1}</td>
                                <td class="py-2 px-4 border-b">${file.file2}</td>
                                <td class="py-2 px-4 border-b">${file.addedKeys || 0}</td>
                                <td class="py-2 px-4 border-b">${file.removedKeys || 0}</td>
                                <td class="py-2 px-4 border-b">${file.modifiedKeys || 0}</td>
                            </tr>
                        `).join('') :
                    '<tr><td colspan="6" class="py-4 text-center text-gray-500">无文件对比数据</td></tr>'}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 详细变更信息 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="p-4 bg-green-50 rounded-lg">
                <h5 class="font-medium text-green-700 mb-2">新增键详情</h5>
                <ul class="text-sm max-h-40 overflow-y-auto" id="addedKeysDetails">
                    ${data.comparedFiles && data.comparedFiles.some(f => f.addedKeysDetails && f.addedKeysDetails.length > 0) ?
                    data.comparedFiles.flatMap(f => f.addedKeysDetails || []).map(key => `<li class="py-1">${key}</li>`).join('') :
                    '<li class="py-1 text-gray-500">无新增键</li>'}
                </ul>
            </div>
            <div class="p-4 bg-red-50 rounded-lg">
                <h5 class="font-medium text-red-700 mb-2">删除键详情</h5>
                <ul class="text-sm max-h-40 overflow-y-auto" id="removedKeysDetails">
                    ${data.comparedFiles && data.comparedFiles.some(f => f.removedKeysDetails && f.removedKeysDetails.length > 0) ?
                    data.comparedFiles.flatMap(f => f.removedKeysDetails || []).map(key => `<li class="py-1">${key}</li>`).join('') :
                    '<li class="py-1 text-gray-500">无删除键</li>'}
                </ul>
            </div>
            <div class="p-4 bg-yellow-50 rounded-lg">
                <h5 class="font-medium text-yellow-700 mb-2">修改键详情</h5>
                <ul class="text-sm max-h-40 overflow-y-auto" id="modifiedKeysDetails">
                    ${data.comparedFiles && data.comparedFiles.some(f => f.modifiedKeysDetails && f.modifiedKeysDetails.length > 0) ?
                    data.comparedFiles.flatMap(f => f.modifiedKeysDetails || []).map(key => `<li class="py-1">${key}</li>`).join('') :
                    '<li class="py-1 text-gray-500">无修改键</li>'}
                </ul>
            </div>
        </div>
    `;
        }
        // CPU刷新控制函数
        function toggleCpuRefresh() {
            cpuRefreshEnabled = !cpuRefreshEnabled;
            const toggleBtn = document.getElementById('cpuRefreshToggle');

            if (cpuRefreshEnabled) {
                toggleBtn.textContent = '暂停刷新';
                toggleBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm';
                startCpuRefresh();
            } else {
                toggleBtn.textContent = '开始刷新';
                toggleBtn.className = 'bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm';
                stopCpuRefresh();
            }
        }

        function changeCpuRefreshInterval() {
            cpuRefreshInterval = parseInt(document.getElementById('cpuRefreshInterval').value);
            if (cpuRefreshEnabled) {
                stopCpuRefresh();
                startCpuRefresh();
            }
        }

        function startCpuRefresh() {
            stopCpuRefresh();
            function refreshLoop() {
                updateCpuUsageData();
                if (cpuRefreshEnabled) {
                    cpuRefreshTimer = setTimeout(() => {
                        requestAnimationFrame(refreshLoop);
                    }, cpuRefreshInterval);
                }
            }
            if (cpuRefreshEnabled) {
                requestAnimationFrame(refreshLoop);
            }
        }

        function stopCpuRefresh() {
            if (cpuRefreshTimer) {
                clearInterval(cpuRefreshTimer);
                cpuRefreshTimer = null;
            }
        }

        // 内存刷新控制函数
        function toggleMemoryRefresh() {
            memoryRefreshEnabled = !memoryRefreshEnabled;
            const toggleBtn = document.getElementById('memoryRefreshToggle');

            if (memoryRefreshEnabled) {
                toggleBtn.textContent = '暂停刷新';
                toggleBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm';
                startMemoryRefresh();
            } else {
                toggleBtn.textContent = '开始刷新';
                toggleBtn.className = 'bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm';
                stopMemoryRefresh();
            }
        }

        function changeMemoryRefreshInterval() {
            memoryRefreshInterval = parseInt(document.getElementById('memoryRefreshInterval').value);
            if (memoryRefreshEnabled) {
                stopMemoryRefresh();
                startMemoryRefresh();
            }
        }

        function startMemoryRefresh() {
            stopMemoryRefresh();
            function refreshLoop() {
                updateMemoryUsageData();
                if (memoryRefreshEnabled) {
                    memoryRefreshTimer = setTimeout(() => {
                        requestAnimationFrame(refreshLoop);
                    }, memoryRefreshInterval);
                }
            }
            if (memoryRefreshEnabled) {
                requestAnimationFrame(refreshLoop);
            }
        }

        function stopMemoryRefresh() {
            if (memoryRefreshTimer) {
                clearInterval(memoryRefreshTimer);
                memoryRefreshTimer = null;
            }
        }

        // 更新CPU使用率数据
        function updateCpuUsageData() {
            // 更新当前CPU使用率
            fetch(`${API_BASE}/cpu/usage`)
                .then(response => response.json())
                .then(data => {
                    const usage = data.usage.toFixed(2);
                    charts.cpuUsageGauge.setOption({
                        series: [{
                            data: [{ value: usage }]
                        }]
                    });

                    // 更新状态显示
                    updateCpuStatus(usage);
                })
                .catch(err => console.error('更新CPU使用率失败:', err));

            // 更新历史数据
            fetch(`${API_BASE}/cpu/history`)
                .then(response => response.json())
                .then(data => {
                    const chartData = data.map(item => [item.timestamp, item.value]);
                    charts.cpuHistoryChart.setOption({
                        series: [{
                            data: chartData
                        }]
                    });
                })
                .catch(err => console.error('更新CPU历史数据失败:', err));
        }

        // 更新内存使用率数据
        function updateMemoryUsageData() {
            // 更新当前内存使用率
            fetch(`${API_BASE}/memory/usage`)
                .then(response => response.json())
                .then(data => {
                    const percent = data.usedPercent;
                    charts.memoryUsageGauge.setOption({
                        series: [{
                            data: [{ value: percent }]
                        }]
                    });

                    // 更新内存状态显示
                    updateMemoryStatus(percent);

                    // 更新内存详细信息
                    document.getElementById('totalMemory').textContent = formatBytes(data.totalPhysical);
                    document.getElementById('usedMemory').textContent = formatBytes(data.usedPhysical);
                    document.getElementById('availableMemory').textContent = formatBytes(data.availablePhysical);
                })
                .catch(err => console.error('更新内存使用率失败:', err));

            // 更新历史数据
            fetch(`${API_BASE}/memory/history`)
                .then(response => response.json())
                .then(data => {
                    const chartData = data.map(item => [item.timestamp, item.value]);
                    charts.memoryHistoryChart.setOption({
                        series: [{
                            data: chartData
                        }]
                    });
                })
                .catch(err => console.error('更新内存历史数据失败:', err));
        }

        // 更新CPU状态显示
        function updateCpuStatus(usage) {
            const statusText = document.getElementById('cpuStatusText');
            const statusDescription = document.getElementById('cpuStatusDescription');

            if (usage > 95) {
                statusText.textContent = '危险';
                statusText.className = 'text-lg font-semibold text-red-600';
                statusDescription.textContent = 'CPU使用率过高';
                statusDescription.className = 'text-sm text-red-500';
            } else if (usage > 80) {
                statusText.textContent = '警告';
                statusText.className = 'text-lg font-semibold text-orange-500';
                statusDescription.textContent = 'CPU使用率较高';
                statusDescription.className = 'text-sm text-orange-400';
            } else {
                statusText.textContent = '良好';
                statusText.className = 'text-lg font-semibold text-green-600';
                statusDescription.textContent = 'CPU使用率正常';
                statusDescription.className = 'text-sm text-gray-500';
            }
        }

        // 初始化快照功能
        function initSnapshotFunctionality() {
            // 创建快照
            document.getElementById('createSystemSnapshotBtn').addEventListener('click', createSystemSnapshot);

            // 刷新快照列表
            // document.getElementById('refreshSnapshotBtn').addEventListener('click', loadSystemSnapshotData);

            // 全选复选框
            document.getElementById('selectAllCheckbox').addEventListener('change', function () {
                const checkboxes = document.querySelectorAll('.snapshot-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateSelectedSnapshots();
            });

            // 对比选中快照
            document.getElementById('compareSelectedSnapshotsBtn').addEventListener('click', compareSelectedSnapshots);

            // 关闭对比结果
            document.getElementById('closeComparisonBtn').addEventListener('click', function () {
                document.getElementById('systemComparisonResult').classList.add('hidden');
            });

            // 页面加载时加载数据
            loadSystemSnapshotData();
        }

        // 更新选中的快照列表
        function updateSelectedSnapshots() {
            selectedSnapshots = [];
            document.querySelectorAll('.snapshot-checkbox:checked').forEach(checkbox => {
                selectedSnapshots.push(checkbox.value);
            });

            const compareBtn = document.getElementById('compareSelectedSnapshotsBtn');
            if (selectedSnapshots.length === 2) {
                compareBtn.classList.remove('hidden');
            } else {
                compareBtn.classList.add('hidden');
            }
        }


        // 对比选中的快照
        function compareSelectedSnapshots() {
            if (selectedSnapshots.length !== 2) {
                alert('请选择两个快照进行对比');
                return;
            }

            const snapshot1 = selectedSnapshots[0];
            const snapshot2 = selectedSnapshots[1];

            // 显示加载状态
            const compareBtn = document.getElementById('compareSelectedSnapshotsBtn');
            const originalBtnText = compareBtn.innerHTML;
            compareBtn.innerHTML = `
        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        对比中...
    `;
            compareBtn.disabled = true;

            fetch(`${API_BASE}/system/snapshot/compare`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    snapshot1,
                    snapshot2
                })
            })
                .then(response => response.json())
                .then(data => {
                    // 恢复按钮状态
                    compareBtn.innerHTML = originalBtnText;
                    compareBtn.disabled = false;

                    if (data.error) {
                        alert(`对比失败: ${data.error}`);
                        return;
                    }

                    // 显示对比结果
                    displaySystemComparisonResult(data);
                })
                .catch(err => {
                    // 恢复按钮状态
                    compareBtn.innerHTML = originalBtnText;
                    compareBtn.disabled = false;

                    console.error('快照对比失败:', err);
                    alert(`快照对比失败: ${err.message}`);
                });
        }
        // 添加加载状态管理
        function showLoadingIndicator(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `
            <tr>
                <td colspan="3" class="py-4 text-center">
                    <div class="flex justify-center items-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>正在加载数据...</span>
                    </div>
                </td>
            </tr>
        `;
            }
        }

        function loadSystemSnapshotData() {
            fetch(`${API_BASE}/system/snapshot/list`)
                .then(response => response.json())
                .then(data => {
                    systemSnapshots = data;
                    const tbody = document.getElementById('systemSnapshotTableBody');

                    if (data.length === 0) {
                        tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="py-4 text-center text-gray-500">
                            暂无快照数据
                        </td>
                    </tr>
                `;
                        return;
                    }

                    tbody.innerHTML = data.map(snapshot => `
                <tr class="hover:bg-gray-50">
                    <td class="py-2 px-4">
                        <input type="checkbox" class="snapshot-checkbox form-checkbox h-4 w-4 text-blue-600" value="${snapshot.name}">
                    </td>
                    <td class="py-2 px-4">${snapshot.name}</td>
                    <td class="py-2 px-4">${new Date(snapshot.timestamp).toLocaleString()}</td>
                    <td class="py-2 px-4">
                        <div class="flex space-x-2">
                            <button onclick="saveSystemSnapshot('${snapshot.name}')" 
                                    class="text-blue-500 hover:text-blue-700">
                                保存
                            </button>
                            <button onclick="exportSystemSnapshot('${snapshot.name}')" 
                                class="text-green-500 hover:text-green-700">
                                导出
                            </button>
                            <button onclick="deleteSystemSnapshot('${snapshot.name}')" 
                                class="text-red-500 hover:text-red-700">
                                删除
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

                    // 为新添加的复选框绑定事件
                    document.querySelectorAll('.snapshot-checkbox').forEach(checkbox => {
                        checkbox.addEventListener('change', updateSelectedSnapshots);
                    });

                    // 重置全选复选框
                    document.getElementById('selectAllCheckbox').checked = false;
                    selectedSnapshots = [];
                    document.getElementById('compareSelectedSnapshotsBtn').classList.add('hidden');
                })
                .catch(err => {
                    console.error('加载快照数据失败:', err);
                    document.getElementById('systemSnapshotTableBody').innerHTML = `
                <tr>
                    <td colspan="4" class="py-4 text-center text-red-500">
                        加载失败: ${err.message}
                    </td>
                </tr>
            `;
                });
        }
        // 刷新快照列表
        //document.getElementById('refreshSnapshotBtn').addEventListener('click', loadSystemSnapshotData);

        // 创建系统快照
        document.getElementById('createSystemSnapshotBtn').addEventListener('click', createSystemSnapshot);


        // 更新快照表格
        function updateSystemSnapshotTable() {
            const tbody = document.getElementById('systemSnapshotTableBody');

            if (systemSnapshots.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="py-4 text-center text-gray-500">暂无快照</td></tr>';
                return;
            }

            tbody.innerHTML = systemSnapshots.map(snapshot => `
        <tr>
            <td class="py-2 px-4 border-b">${snapshot.name}</td>
            <td class="py-2 px-4 border-b">${new Date(snapshot.timestamp).toLocaleString()}</td>
            <td class="py-2 px-4 border-b">
                <button class="text-blue-500 hover:text-blue-700 mr-2 view-snapshot" data-name="${snapshot.name}">
                    查看
                </button>
                <button class="text-green-500 hover:text-green-700 mr-2 save-snapshot" data-name="${snapshot.name}">
                    保存
                </button>
                <button class="text-red-500 hover:text-red-700 delete-snapshot" data-name="${snapshot.name}">
                    删除
                </button>
            </td>
        </tr>
    `).join('');

            // 绑定事件
            document.querySelectorAll('.view-snapshot').forEach(btn => {
                btn.addEventListener('click', function () {
                    const name = this.getAttribute('data-name');
                    viewSystemSnapshot(name);
                });
            });

            document.querySelectorAll('.save-snapshot').forEach(btn => {
                btn.addEventListener('click', function () {
                    const name = this.getAttribute('data-name');
                    saveSystemSnapshot(name);
                });
            });

            document.querySelectorAll('.delete-snapshot').forEach(btn => {
                btn.addEventListener('click', function () {
                    const name = this.getAttribute('data-name');
                    deleteSystemSnapshot(name);
                });
            });
        }

        function updateSystemSnapshotDropdowns(snapshots) {
            const snapshot1Select = document.getElementById('snapshot1Select');
            const snapshot2Select = document.getElementById('snapshot2Select');

            let options = '<option value="">请选择快照</option>';
            snapshots.forEach(snapshot => {
                options += `<option value="${snapshot.name}">${snapshot.name}</option>`;
            });

            snapshot1Select.innerHTML = options;
            snapshot2Select.innerHTML = options;
        }

        // 对比系统快照
        document.getElementById('compareSystemSnapshotsBtn').addEventListener('click', compareSystemSnapshots);


        function createSystemSnapshot() {
            const nameInput = document.getElementById('snapshotNameInput');
            const snapshotName = nameInput.value.trim() || `snapshot_${new Date().toISOString().replace(/[:.-]/g, '').slice(0, 15)}`;

            // 显示加载状态
            const createBtn = document.getElementById('createSystemSnapshotBtn');
            const originalBtnText = createBtn.innerHTML;
            createBtn.innerHTML = `
        <div class="flex items-center">
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            创建中...
        </div>
    `;
            createBtn.disabled = true;

            fetch(`${API_BASE}/system/snapshot/create`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: snapshotName })
            })
                .then(response => response.json())
                .then(data => {
                    // 恢复按钮状态
                    createBtn.innerHTML = originalBtnText;
                    createBtn.disabled = false;

                    if (data.success) {
                        // 显示成功状态
                        document.getElementById('snapshotNameDisplay').textContent = data.name;
                        document.getElementById('snapshotStatus').classList.remove('hidden');

                        // 清空输入框
                        nameInput.value = '';

                        // 重新加载快照列表
                        loadSystemSnapshotData();

                        // 3秒后隐藏状态信息
                        setTimeout(() => {
                            document.getElementById('snapshotStatus').classList.add('hidden');
                        }, 3000);
                    } else {
                        alert(`快照创建失败: ${data.error}`);
                    }
                })
                .catch(err => {
                    // 恢复按钮状态
                    createBtn.innerHTML = originalBtnText;
                    createBtn.disabled = false;

                    console.error('创建系统快照失败:', err);
                    alert(`创建系统快照失败: ${err.message}`);
                });
        }

        // 添加一个辅助函数来安全地格式化数字
        function safeToFixed(value, decimals = 2) {
            if (typeof value !== 'number' || isNaN(value)) {
                return 'N/A';
            }
            return value.toFixed(decimals);
        }

        // 查看系统快照详情
        function viewSystemSnapshot(name) {
            fetch(`${API_BASE}/system/snapshot/get?name=${encodeURIComponent(name)}`)
                .then(response => response.json())
                .then(data => {
                    // 添加一个辅助函数来安全地格式化数字
                    function safeToFixed(value, decimals = 2) {
                        if (typeof value !== 'number' || isNaN(value)) {
                            return 'N/A';
                        }
                        return value.toFixed(decimals);
                    }

                    const content = document.getElementById('snapshotDetailContent');
                    content.innerHTML = `
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <h4 class="font-semibold text-lg mb-2">快照信息</h4>
                    <p><span class="font-medium">名称:</span> ${name}</p>
                    <p><span class="font-medium">时间:</span> ${new Date(data.cpu.timestamp).toLocaleString()}</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h4 class="font-semibold mb-2">CPU信息</h4>
                        <p><span class="font-medium">使用率:</span> ${safeToFixed(data.cpu.usage)}%</p>
                        <p><span class="font-medium">核心数:</span> ${data.cpu.coreCount || 'N/A'}</p>
                    </div>
                    
                    <div class="bg-green-50 rounded-lg p-4">
                        <h4 class="font-semibold mb-2">内存信息</h4>
                        <p><span class="font-medium">已使用:</span> ${safeToFixed(data.memory.usedPhysical / (1024 ** 3))} GB</p>
                        <p><span class="font-medium">总计:</span> ${safeToFixed(data.memory.totalPhysical / (1024 ** 3))} GB</p>
                        <p><span class="font-medium">使用率:</span> ${safeToFixed(data.memory.usedPhysicalPercent)}%</p>
                    </div>
                </div>
                
                <div class="bg-yellow-50 rounded-lg p-4 mb-4">
                    <h4 class="font-semibold mb-2">磁盘信息</h4>
                    <div class="grid grid-cols-1 gap-2">
                        ${data.partitions && data.partitions.length > 0 ?
                            data.partitions.map(partition => `
                            <div class="bg-white rounded p-2 mb-1">
                                <p><span class="font-medium">${partition.driveLetter}:</span> 
                                ${safeToFixed(partition.usedSpace / (1024 ** 3))} GB / ${safeToFixed(partition.totalSize / (1024 ** 3))} GB 
                                (${safeToFixed(partition.usagePercentage)}%)</p>
                            </div>
                        `).join('') :
                            '<p>无分区信息</p>'}
                    </div>
                </div>
                
                <div class="bg-purple-50 rounded-lg p-4">
                    <h4 class="font-semibold mb-2">驱动信息</h4>
                    <p><span class="font-medium">总驱动数:</span> ${data.driver.stats.totalDrivers || 'N/A'}</p>
                    <p><span class="font-medium">运行中:</span> ${data.driver.stats.runningCount || 'N/A'}</p>
                    <p><span class="font-medium">已停止:</span> ${data.driver.stats.stoppedCount || 'N/A'}</p>
                </div>
            `;

                    document.getElementById('snapshotDetailModal').classList.remove('hidden');
                })
                .catch(err => {
                    console.error('获取快照详情失败:', err);
                    alert(`获取快照详情失败: ${err.message}`);
                });
        }
        // 关闭快照详情模态框
        function closeSnapshotDetailModal() {
            document.getElementById('snapshotDetailModal').classList.add('hidden');
        }

        // 保存系统快照
        function saveSystemSnapshot(name) {
            if (!confirm(`确定要保存快照 "${name}" 到磁盘吗？`)) return;

            fetch(`${API_BASE}/system/snapshot/save`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`快照 "${name}" 保存成功`);
                    } else {
                        alert(`快照保存失败: ${data.error}`);
                    }
                })
                .catch(err => {
                    console.error('保存系统快照失败:', err);
                    alert(`保存系统快照失败: ${err.message}`);
                });
        }
        // 删除系统快照
        function deleteSystemSnapshot(name) {
            if (!confirm(`确定要删除系统快照 "${name}" 吗？`)) return;

            fetch(`${API_BASE}/system/snapshot/delete/${name}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('系统快照删除成功');
                        loadSystemSnapshotData();
                    } else {
                        alert(`系统快照删除失败: ${data.error}`);
                    }
                })
                .catch(err => {
                    console.error('删除系统快照失败:', err);
                    alert(`删除系统快照失败: ${err.message}`);
                });
        }

        // 对比系统快照
        function compareSystemSnapshots() {
            const snapshot1 = document.getElementById('snapshot1Select').value;
            const snapshot2 = document.getElementById('snapshot2Select').value;

            if (!snapshot1 || !snapshot2) {
                alert('请选择两个快照进行对比');
                return;
            }

            const compareBtn = document.getElementById('compareSystemSnapshotsBtn');
            const originalBtnText = compareBtn.innerHTML;
            compareBtn.innerHTML = '<span class="flex items-center"><svg class="animate-spin h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>正在对比...</span>';
            compareBtn.disabled = true;

            fetch(`${API_BASE}/system/snapshot/compare`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ snapshot1, snapshot2 })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        const resultElement = document.getElementById('systemComparisonResult');
                        resultElement.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                        <div class="flex items-center">
                            <svg class="h-5 w-5 text-red-400 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                            <h4 class="text-lg font-medium text-red-800">请求失败</h4>
                        </div>
                        <p class="mt-2 text-red-700">对比系统快照时发生错误: ${data.error}</p>
                        <button onclick="this.parentElement.parentElement.classList.add('hidden')" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">关闭</button>
                    </div>
                `;
                        resultElement.classList.remove('hidden');
                        return;
                    }

                    displaySystemComparisonResult(data);
                })
                .catch(err => {
                    const resultElement = document.getElementById('systemComparisonResult');
                    resultElement.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                    <div class="flex items-center">
                        <svg class="h-5 w-5 text-red-400 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                        <h4 class="text-lg font-medium text-red-800">网络错误</h4>
                    </div>
                    <p class="mt-2 text-red-700">无法连接服务器: ${err.message}</p>
                    <button onclick="this.parentElement.parentElement.classList.add('hidden')" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">关闭</button>
                </div>
            `;
                    resultElement.classList.remove('hidden');
                })
                .finally(() => {
                    compareBtn.innerHTML = originalBtnText;
                    compareBtn.disabled = false;
                });
        }


        function exportSystemSnapshot(name) {
            fetch(`${API_BASE}/system/snapshot/get?name=${encodeURIComponent(name)}`)
                .then(response => response.json())
                .then(data => {
                    // 创建要下载的数据
                    const jsonData = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);

                    // 创建下载链接
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `system_snapshot_${name}.json`;
                    document.body.appendChild(a);
                    a.click();

                    // 清理
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                })
                .catch(err => {
                    console.error('导出快照失败:', err);
                    alert(`导出快照失败: ${err.message}`);
                });
        }


        // 显示系统快照对比结果
        // 完整的 displaySystemComparisonResult 函数（已合并上述改动）
        function displaySystemComparisonResult(data) {
            const content = document.getElementById('systemComparisonContent');
            const resultContainer = document.getElementById('systemComparisonResult');

            /* ---------- 0. 快照名称头部卡片 ---------- */
            const headHtml = `
    <div class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-xl shadow-md p-6 mb-6">
      <h3 class="text-lg font-bold text-gray-800 mb-2">对比快照</h3>
      <div class="flex items-center space-x-4">
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
          ${data.snapshot1}
        </span>
        <span class="text-gray-400">VS</span>
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
          ${data.snapshot2}
        </span>
      </div>
    </div>`;

            /* ---------- 1. 关键指标卡片 ---------- */
            const cpuDiff = data.cpu?.totalUsageDiff ?? 0;
            const memDiff = data.memory?.usedPhysicalDiff ?? 0;
            const procAdded = data.processes?.addedCount ?? 0;
            const regMod = data.registry?.totalModifiedKeys ?? 0;

            const statHtml = `
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-6">
      <div class="bg-white rounded-xl shadow-md p-6 flex items-center"><div class="p-3 rounded-full bg-blue-100 mr-4"><svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/></svg></div><div><p class="text-sm text-gray-500">CPU 变化</p><p class="text-2xl font-bold ${cpuDiff > 0 ? 'text-red-500' : 'text-green-500'}">${cpuDiff > 0 ? '+' : ''}${cpuDiff.toFixed(2)}%</p></div></div>
      <div class="bg-white rounded-xl shadow-md p-6 flex items-center"><div class="p-3 rounded-full bg-green-100 mr-4"><svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg></div><div><p class="text-sm text-gray-500">内存变化</p><p class="text-2xl font-bold ${memDiff > 0 ? 'text-red-500' : 'text-green-500'}">${memDiff > 0 ? '+' : ''}${formatBytes(Math.abs(memDiff))}</p></div></div>
      <div class="bg-white rounded-xl shadow-md p-6 flex items-center"><div class="p-3 rounded-full bg-purple-100 mr-4"><svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg></div><div><p class="text-sm text-gray-500">新增进程</p><p class="text-2xl font-bold text-green-600">+${procAdded}</p></div></div>
      <div class="bg-white rounded-xl shadow-md p-6 flex items-center"><div class="p-3 rounded-full bg-yellow-100 mr-4"><svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/></svg></div><div><p class="text-sm text-gray-500">注册表修改</p><p class="text-2xl font-bold text-yellow-600">+${regMod}</p></div></div>
    </div>`;

            /* ---------- 2. CPU 折叠卡片 ---------- */
            const cpuHtml = `
    <div class="bg-white rounded-xl shadow-md overflow-hidden mb-6">
      <div class="p-6 cursor-pointer bg-gradient-to-r from-blue-50 to-blue-100 hover:from-blue-100 hover:to-blue-200 transition-all duration-300" onclick="toggleExpand('cpuExpand')">
        <div class="flex justify-between items-center">
          <div>
            <h2 class="text-xl font-bold text-gray-800 flex items-center">
              <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/></svg>
              CPU 对比分析
            </h2>
            <p class="text-gray-600 mt-1">总使用率变化：<span class="font-semibold ${cpuDiff > 0 ? 'text-red-500' : 'text-green-500'}">${cpuDiff > 0 ? '+' : ''}${cpuDiff.toFixed(2)}%</span></p>
          </div>
          <svg class="w-5 h-5 transform transition-transform" id="cpuExpandIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </div>
      </div>
      <div id="cpuExpand" class="expandable-content">
        <div class="p-6 border-t border-gray-100">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
            <div class="bg-gray-50 rounded-lg p-4"><p class="text-sm text-gray-500">快照1总使用率</p><p class="text-lg font-semibold">${(data.cpu?.totalUsage1 ?? 0).toFixed(2)}%</p></div>
            <div class="bg-gray-50 rounded-lg p-4"><p class="text-sm text-gray-500">快照2总使用率</p><p class="text-lg font-semibold">${(data.cpu?.totalUsage2 ?? 0).toFixed(2)}%</p></div>
            <div class="bg-gray-50 rounded-lg p-4"><p class="text-sm text-gray-500">变化量</p><p class="text-lg font-semibold ${cpuDiff > 0 ? 'text-red-500' : 'text-green-500'}">${cpuDiff > 0 ? '+' : ''}${cpuDiff.toFixed(2)}%</p></div>
            <div class="bg-gray-50 rounded-lg p-4"><p class="text-sm text-gray-500">核心数</p><p class="text-lg font-semibold">${data.cpu?.coreUsageDiffs?.length ?? 0}</p></div>
          </div>
        </div>
      </div>
    </div>`;

            /* ---------- 3. 内存 折叠卡片 ---------- */
            const mem = data.memory ?? {};
            const memHtml = `
    <div class="bg-white rounded-xl shadow-md overflow-hidden mb-6">
      <div class="p-6 cursor-pointer bg-gradient-to-r from-green-50 to-green-100 hover:from-green-100 hover:to-green-200 transition-all duration-300" onclick="toggleExpand('memExpand')">
        <div class="flex justify-between items-center">
          <div>
            <h2 class="text-xl font-bold text-gray-800 flex items-center">
              <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>
              内存 对比分析
            </h2>
            <p class="text-gray-600 mt-1">可用内存变化：<span class="font-semibold ${mem.availablePhysicalDiff > 0 ? 'text-green-500' : 'text-red-500'}">${mem.availablePhysicalDiff > 0 ? '+' : ''}${formatBytes(Math.abs(mem.availablePhysicalDiff))}</span></p>
          </div>
          <svg class="w-5 h-5 transform transition-transform" id="memExpandIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </div>
      </div>
      <div id="memExpand" class="expandable-content">
        <div class="p-6 border-t border-gray-100">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-gray-50 rounded-lg p-4"><p class="text-sm text-gray-500">总物理内存</p><p class="text-xl font-semibold">${formatBytes(mem.totalPhysical1 ?? 0)}</p><p class="text-sm text-gray-500 mt-1">无变化</p></div>
            <div class="bg-gray-50 rounded-lg p-4"><p class="text-sm text-gray-500">可用内存变化</p><p class="text-xl font-semibold ${mem.availablePhysicalDiff > 0 ? 'text-green-500' : 'text-red-500'}">${mem.availablePhysicalDiff > 0 ? '+' : ''}${formatBytes(Math.abs(mem.availablePhysicalDiff))}</p><p class="text-sm text-gray-500 mt-1">${formatBytes(mem.availablePhysical1 ?? 0)} → ${formatBytes(mem.availablePhysical2 ?? 0)}</p></div>
            <div class="bg-gray-50 rounded-lg p-4"><p class="text-sm text-gray-500">使用率变化</p><p class="text-xl font-semibold ${mem.usedPercentDiff > 0 ? 'text-red-500' : 'text-green-500'}">${mem.usedPercentDiff > 0 ? '+' : ''}${(mem.usedPercentDiff ?? 0).toFixed(2)}%</p><p class="text-sm text-gray-500 mt-1">${(mem.usedPercent1 ?? 0).toFixed(1)}% → ${(mem.usedPercent2 ?? 0).toFixed(1)}%</p></div>
          </div>
        </div>
      </div>
    </div>`;

            /* ---------- 4. 磁盘 折叠卡片 ---------- */
            const diskHtml = `
    <div class="bg-white rounded-xl shadow-md overflow-hidden mb-6">
      <div class="p-6 cursor-pointer bg-gradient-to-r from-purple-50 to-purple-100 hover:from-purple-100 hover:to-purple-200 transition-all duration-300" onclick="toggleExpand('diskExpand')">
        <div class="flex justify-between items-center">
          <div>
            <h2 class="text-xl font-bold text-gray-800 flex items-center">
              <svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/></svg>
              磁盘 对比分析
            </h2>
            <p class="text-gray-600 mt-1">分区变化概览</p>
          </div>
          <svg class="w-5 h-5 transform transition-transform" id="diskExpandIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </div>
      </div>
      <div id="diskExpand" class="expandable-content">
        <div class="p-6 border-t border-gray-100">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">盘符</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">名称</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">文件系统</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">总大小</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">已用空间变化</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">使用率变化</th>
            </tr></thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${(data.disk?.partitions?.changes ?? []).map(p => `
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 text-sm font-medium">${p.driveLetter}</td>
                <td class="px-4 py-3 text-sm">${p.label}</td>
                <td class="px-4 py-3 text-sm">${p.fileSystem}</td>
                <td class="px-4 py-3 text-sm">${formatBytes(p.totalSize1)}</td>
                <td class="px-4 py-3 text-sm ${p.usedSpaceDiff > 0 ? 'text-red-500' : 'text-green-500'} font-medium">${p.usedSpaceDiff > 0 ? '+' : ''}${formatBytes(Math.abs(p.usedSpaceDiff))}</td>
                <td class="px-4 py-3 text-sm ${p.usagePercentageDiff > 0 ? 'text-red-500' : 'text-green-500'} font-medium">${p.usagePercentageDiff > 0 ? '+' : ''}${p.usagePercentageDiff.toFixed(3)}%</td>
              </tr>`).join('')}
            </tbody></table>
          </div>
        </div>
      </div>
    </div>`;

            /* ---------- 5. 进程 折叠卡片（带切换） ---------- */
            const proc = data.processes ?? {};
            const procHtml = `
    <div class="bg-white rounded-xl shadow-md overflow-hidden mb-6">
      <div class="p-6 cursor-pointer bg-gradient-to-r from-orange-50 to-orange-100 hover:from-orange-100 hover:to-orange-200 transition-all duration-300" onclick="toggleExpand('procExpand')">
        <div class="flex justify-between items-center">
          <div>
            <h2 class="text-xl font-bold text-gray-800 flex items-center">
              <svg class="w-6 h-6 mr-2 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
              进程 对比分析
            </h2>
            <p class="text-gray-600 mt-1">新增 <span class="font-semibold text-green-600">${proc.addedCount ?? 0}</span> · 变化 <span class="font-semibold text-yellow-600">${proc.changedCount ?? 0}</span> · 移除 <span class="font-semibold text-red-600">${proc.removedCount ?? 0}</span></p>
          </div>
          <svg class="w-5 h-5 transform transition-transform" id="procExpandIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </div>
      </div>
      <div id="procExpand" class="expandable-content">
        <div class="p-6 border-t border-gray-100">
          <!-- 切换按钮组 -->
          <div class="flex justify-center mb-4">
            <div class="inline-flex rounded-md shadow-sm" role="group">
              <button onclick="switchProcTable('added')" id="btn-added" class="proc-tab-btn px-4 py-2 text-sm font-medium rounded-l-lg border border-green-300 bg-green-50 text-green-700 hover:bg-green-100 focus:z-10 focus:ring-2 focus:ring-green-500">
                新增进程
              </button>
              <button onclick="switchProcTable('changed')" id="btn-changed" class="proc-tab-btn px-4 py-2 text-sm font-medium border-t border-b border-yellow-300 bg-white text-gray-700 hover:bg-yellow-50 focus:z-10 focus:ring-2 focus:ring-yellow-500">
                变化进程
              </button>
              <button onclick="switchProcTable('removed')" id="btn-removed" class="proc-tab-btn px-4 py-2 text-sm font-medium rounded-r-lg border border-red-300 bg-white text-gray-700 hover:bg-red-50 focus:z-10 focus:ring-2 focus:ring-red-500">
                移除进程
              </button>
            </div>
          </div>
          <!-- 表格容器 -->
          <div id="procTableContainer" class="rounded-lg border border-gray-200 overflow-hidden" style="max-height:50vh; overflow-y:auto;">
    <!-- 动态表格内容 -->
          </div>
        </div>
      </div>
    </div>`;

            /* ---------- 6. 注册表 折叠卡片 ---------- */
            const reg = data.registry ?? {};
            const regHtml = `
    <div class="bg-white rounded-xl shadow-md overflow-hidden mb-6">
      <div class="p-6 cursor-pointer bg-gradient-to-r from-pink-50 to-pink-100 hover:from-pink-100 hover:to-pink-200 transition-all duration-300" onclick="toggleExpand('regExpand')">
        <div class="flex justify-between items-center">
          <div>
            <h2 class="text-xl font-bold text-gray-800 flex items-center">
              <svg class="w-6 h-6 mr-2 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/></svg>
              注册表 对比分析
            </h2>
            <p class="text-gray-600 mt-1">共对比 <span class="font-semibold">${reg.totalComparedFiles ?? 0}</span> 个文件 · 修改 <span class="font-semibold text-yellow-600">${reg.totalModifiedKeys ?? 0}</span> 项</p>
          </div>
          <svg class="w-5 h-5 transform transition-transform" id="regExpandIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </div>
      </div>
      <div id="regExpand" class="expandable-content">
        <div class="p-6 border-t border-gray-100">
          <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
            <div class="bg-blue-50 rounded-lg p-3 text-center"><p class="text-sm text-blue-600">对比文件</p><p class="text-lg font-bold text-blue-700">${reg.totalComparedFiles ?? 0}</p></div>
            <div class="bg-green-50 rounded-lg p-3 text-center"><p class="text-sm text-green-600">新增键</p><p class="text-lg font-bold text-green-700">${reg.totalAddedKeys ?? 0}</p></div>
            <div class="bg-red-50 rounded-lg p-3 text-center"><p class="text-sm text-red-600">删除键</p><p class="text-lg font-bold text-red-700">${reg.totalRemovedKeys ?? 0}</p></div>
            <div class="bg-yellow-50 rounded-lg p-3 text-center"><p class="text-sm text-yellow-600">修改键</p><p class="text-lg font-bold text-yellow-700">${reg.totalModifiedKeys ?? 0}</p></div>
            <div class="bg-purple-50 rounded-lg p-3 text-center"><p class="text-sm text-purple-600">独有文件</p><p class="text-lg font-bold text-purple-700">${(reg.filesOnlyInFolder1?.length ?? 0) + (reg.filesOnlyInFolder2?.length ?? 0)}</p></div>
          </div>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">文件1</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">文件2</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">新增键</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">删除键</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">修改键</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${(reg.comparedFiles ?? []).map((f, idx) => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm font-medium text-blue-600">${f.file1}</td>
                            <td class="px-4 py-3 text-sm font-medium text-green-600">${f.file2}</td>
                            <td class="px-4 py-3 text-sm">${f.addedKeys}</td>
                            <td class="px-4 py-3 text-sm">${f.removedKeys}</td>
                            <td class="px-4 py-3 text-sm ${f.modifiedKeys > 0 ? 'text-yellow-600 font-medium' : ''}">${f.modifiedKeys}</td>
                            <td class="px-4 py-3 text-sm">
                                <button onclick="showRegistryDetail(${idx})" class="text-indigo-600 hover:text-indigo-900">查看详情</button>
                            </td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>

            <!-- 注册表详情模态窗口 -->
            <div id="registryDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                <div class="bg-white rounded-lg shadow-lg w-2/3 max-h-[80vh] overflow-y-auto">
                    <div class="border-b p-4 flex justify-between items-center">
                        <h3 class="text-lg font-semibold">注册表详情</h3>
                        <button onclick="closeRegistryDetailModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    <div class="p-6" id="registryDetailContent">
                        <!-- 详细内容将在这里显示 -->
                    </div>
                </div>
            </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-green-50 rounded-lg p-3"><h4 class="font-medium text-green-700 mb-1">新增键详情</h4><ul class="text-sm space-y-1">${(reg.comparedFiles ?? []).flatMap(f => f.addedKeysDetails ?? []).map(k => `<li>${k}</li>`).join('') || '<li class="text-gray-500">无新增键</li>'}</ul></div>
            <div class="bg-red-50 rounded-lg p-3"><h4 class="font-medium text-red-700 mb-1">删除键详情</h4><ul class="text-sm space-y-1">${(reg.comparedFiles ?? []).flatMap(f => f.removedKeysDetails ?? []).map(k => `<li>${k}</li>`).join('') || '<li class="text-gray-500">无删除键</li>'}</ul></div>
            <div class="bg-yellow-50 rounded-lg p-3"><h4 class="font-medium text-yellow-700 mb-1">修改键详情</h4><ul class="text-sm space-y-1 max-h-40 overflow-y-auto">${(reg.comparedFiles ?? []).flatMap(f => f.modifiedKeysDetails ?? []).map(k => `<li>${k}</li>`).join('') || '<li class="text-gray-500">无修改键</li>'}</ul></div>
          </div>
        </div>
      </div>
    </div>`;

            /* ---------- 7. 组装并注入 ---------- */
            content.innerHTML = headHtml + statHtml + cpuHtml + memHtml + diskHtml + procHtml + regHtml;
            resultContainer.classList.remove('hidden');

            window.comparisonData = data;

            /* ---------- 8. 渲染默认进程表格 & 注册切换函数 ---------- */
            window.switchProcTable = function (type) {
                const map = {
                    added: {
                        data: proc.added ?? [],
                        headers: ['进程名', 'PID', '线程数', '内存使用'],
                        keys: ['name', 'pid', 'threadCount', 'memoryUsage'],
                        color: 'green'
                    },
                    changed: {
                        data: proc.changed ?? [],
                        headers: ['进程名', 'PID', '线程数变化', '内存变化'],
                        keys: ['name', 'pid', 'threadCountDiff', 'memoryUsageDiff'],
                        color: 'yellow'
                    },
                    removed: {
                        data: proc.removed ?? [],
                        headers: ['进程名', 'PID'],
                        keys: ['name', 'pid'],
                        color: 'red'
                    }
                };
                const cfg = map[type];
                const tbody = cfg.data.map(p => `<tr class="hover:bg-gray-50">
      ${cfg.keys.map(k => `<td class="px-4 py-2 text-sm">${k === 'memoryUsage' || k === 'memoryUsageDiff'
                    ? formatBytes(Math.abs(p[k] ?? 0)) + ' ' + (p[k] < 0 ? '↓' : '↑')
                    : p[k] ?? ''
                    }</td>`).join('')}
    </tr>`).join('') || `<tr><td colspan="${cfg.headers.length}" class="text-center text-gray-500 py-4">无数据</td></tr>`;
                const table = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-${cfg.color}-50"><tr>
      ${cfg.headers.map(h => `<th class="px-4 py-2 text-left text-xs font-medium text-${cfg.color}-700 uppercase">${h}</th>`).join('')}
    </tr></thead><tbody class="bg-white divide-y divide-gray-200">${tbody}</tbody></table>`;
                document.getElementById('procTableContainer').innerHTML = table;

                // 按钮状态
                document.querySelectorAll('.proc-tab-btn').forEach(btn => {
                    btn.classList.remove('bg-green-50', 'bg-yellow-50', 'bg-red-50', 'text-green-700', 'text-yellow-700', 'text-red-700');
                    btn.classList.add('bg-white', 'text-gray-700');
                });
                const active = document.getElementById('btn-' + type);
                active.classList.remove('bg-white', 'text-gray-700');
                active.classList.add(`bg-${cfg.color}-50`, `text-${cfg.color}-700`);
            };

            // 首次渲染
            switchProcTable('added');

            /* ---------- 9. 动画 ---------- */
            anime({
                targets: '.comparison-card',
                translateY: [20, 0],
                opacity: [0, 1],
                delay: anime.stagger(100),
                duration: 800,
                easing: 'easeOutQuad'
            });
        }
        // 优化磁盘分区变化显示函数
        function displayDiskPartitionChanges(data) {
            const contentContainer = document.getElementById('systemComparisonContent');

            // 如果没有磁盘分区变化数据，则返回
            if (!data.disk || !data.disk.partitions || !data.disk.partitions.changes || data.disk.partitions.changes.length === 0) {
                const fragment = document.createDocumentFragment();
                const div = document.createElement('div');
                div.className = 'bg-gray-50 rounded-lg p-4 mb-6';
                div.innerHTML = `
            <h4 class="font-semibold text-lg mb-2">磁盘分区变化</h4>
            <p class="text-gray-500">无磁盘分区变化数据</p>
        `;
                fragment.appendChild(div);
                contentContainer.appendChild(fragment);
                return;
            }

            let diskChangesHTML = `
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
            <h4 class="font-semibold text-lg mb-2">磁盘分区变化</h4>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">驱动器</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">卷标</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">文件系统</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">总大小变化</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">已用空间变化</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">可用空间变化</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">使用率变化</th>
                        </tr>
                    </thead>
    `;

            // 构建表格内容
            diskChangesHTML += '<tbody>';
            data.disk.partitions.changes.forEach(change => {
                diskChangesHTML += `
            <tr>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${change.drive}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${change.label || '-'}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${change.fileSystem || '-'}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${change.totalSizeChange || '-'}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${change.usedSpaceChange || '-'}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${change.freeSpaceChange || '-'}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${change.usageChange || '-'}</td>
            </tr>
        `;
            });
            diskChangesHTML += '</tbody></table></div></div></div>';

            // 一次性更新DOM
            contentContainer.innerHTML += diskChangesHTML;
        }
        // 辅助函数：根据差异值返回相应的CSS类
        function getDiffClass(diffValue) {
            if (diffValue > 0) {
                return 'text-red-500 font-semibold'; // 增加用红色表示
            } else if (diffValue < 0) {
                return 'text-green-500 font-semibold'; // 减少用绿色表示
            } else {
                return 'text-gray-500'; // 无变化用灰色表示
            }
        }

        // 辅助函数：格式化字节大小并带符号显示
        function formatBytesWithSign(bytes) {
            if (bytes === 0) return '0 B';

            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(Math.abs(bytes)) / Math.log(k));
            const formattedValue = parseFloat(Math.abs(bytes) / Math.pow(k, i)).toFixed(2);

            // 添加符号
            const sign = bytes > 0 ? '+' : '';
            return `${sign}${formattedValue} ${sizes[i]}`;
        }

        // 辅助函数：格式化百分比并带符号显示
        function formatPercentageWithSign(percentage) {
            if (percentage === 0) return '0%';

            // 将小数转换为百分比并保留两位小数
            const formattedValue = (Math.abs(percentage)).toFixed(2);
            const sign = percentage > 0 ? '+' : '';
            return `${sign}${formattedValue}%`;
        }

        // 格式化字节大小
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function toggleExpand(id) {
            const content = document.getElementById(id);
            const icon = document.getElementById(id + 'Icon');
            if (!content || !icon) return;

            const isOpen = content.style.maxHeight && content.style.maxHeight !== '0px';
            if (isOpen) {
                content.style.maxHeight = '0px';
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.style.maxHeight = content.scrollHeight + 'px';
                icon.style.transform = 'rotate(180deg)';
            }
        }

        // 显示注册表详情
        function showRegistryDetail(index) {
            const reg = window.comparisonData?.registry ?? {};
            const file = reg.comparedFiles?.[index];
            if (!file) return;

            const content = `
        <div class="space-y-6">
            ${file.addedKeysDetails?.length ? `
            <div class="bg-green-50 rounded-lg p-4">
                <h4 class="font-medium text-green-700 mb-2">新增键 (${file.addedKeysDetails.length})</h4>
                <ul class="text-sm space-y-1 max-h-40 overflow-y-auto">
                    ${file.addedKeysDetails.map(k => `<li class="font-mono text-xs">${k}</li>`).join('')}
                </ul>
            </div>` : ''}

            ${file.removedKeysDetails?.length ? `
            <div class="bg-red-50 rounded-lg p-4">
                <h4 class="font-medium text-red-700 mb-2">删除键 (${file.removedKeysDetails.length})</h4>
                <ul class="text-sm space-y-1 max-h-40 overflow-y-auto">
                    ${file.removedKeysDetails.map(k => `<li class="font-mono text-xs">${k}</li>`).join('')}
                </ul>
            </div>` : ''}

            ${file.modifiedKeysDetails?.length ? `
            <div class="bg-yellow-50 rounded-lg p-4">
                <h4 class="font-medium text-yellow-700 mb-2">修改键 (${file.modifiedKeysDetails.length})</h4>
                <ul class="text-sm space-y-1 max-h-40 overflow-y-auto">
                    ${file.modifiedKeysDetails.map(k => `<li class="font-mono text-xs">${k}</li>`).join('')}
                </ul>
            </div>` : ''}

            ${!file.addedKeysDetails?.length && !file.removedKeysDetails?.length && !file.modifiedKeysDetails?.length ? `
            <div class="text-center text-gray-500 py-8">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </path>
                </svg>
                <p class="mt-2 text-sm">该文件无详细变更信息</p>
            </div>` : ''}
        </div>
    `;

            document.getElementById('registryDetailContent').innerHTML = content;
            document.getElementById('registryDetailModal').classList.remove('hidden');
        }

        // 关闭注册表详情模态窗口
        function closeRegistryDetailModal() {
            document.getElementById('registryDetailModal').classList.add('hidden');
        }

        // 窗口大小改变时重绘图表
        window.addEventListener('resize', function () {
            for (let chartName in charts) {
                if (charts[chartName]) {
                    charts[chartName].resize();
                }
            }
        });

        // 页面卸载时清理定时器
        window.addEventListener('beforeunload', function () {
            stopCpuRefresh();
            stopMemoryRefresh();
            stopDiskRefresh();
        });

        setInterval(loadOverviewData, 2000);

    </script>
</body>

</html>